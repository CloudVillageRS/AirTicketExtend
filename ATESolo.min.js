"use strict";(function(n,l,t){const e=0;const s=1;const i=2;const a=3;const h=4;const r=14;const o=23;const c=24;const d=34;const m=44;const p=48;const w=65;const u={A:"red",B:"green",C:"brown",D:"aqua"};function f(t,e){return t+Math.floor(Math.random()*(e-t+1))}function g(e){if(e.startsWith("[")&&e.endsWith("]")){let t=e.slice(1,-1).split(",");return f(parseInt(t[0]),parseInt(t[1]))}else{return parseInt(e)}}class v{constructor(t,e,s,i){this.$element=t.$input;this.$input=n("<input/>").attr("type","text").appendTo(this.$element).on("keypress",t=>{if(t.which===13){const e=this.getValue();if(!s(e)){return}i(e,this)}});this.$shoot=I.button("走你").appendTo(this.$element).on("click",()=>{const t=this.getValue();if(!s(t)){return}i(t,this)});const a=s===A.check5Capitals;for(let t of e){I.button(t,{margin:"10px",padding:"16px",color:a?u[t]:null}).appendTo(this.$element).on("click",()=>this.setValue(this.getValue()+t))}this.$element.append("<br>");this.$clear=I.button("清除",{cls:"negative"}).appendTo(this.$element).on("click",()=>this.setValue(""))}setValue(t){this.$input.val(t);return this}getValue(){return this.$input.val()}remove(){this.$element.html("")}}class b{constructor(t,e,s,i){this.name=t;this.full=i;this.$title=n("<td/>").html(t).appendTo(e.$tr);this.$valCell=n("<td/>").appendTo(e.$tr);this.$val=n("<span/>").appendTo(this.$valCell);if(s&&i){this.$rate=n("<div/>").addClass("ate-info-rate").insertAfter(this.$val);if(s.startsWith("linear-gradient")){this.$rate.css("backgroundImage",s)}else{this.$rate.css("backgroundColor",s)}}}show(){this.$valCell.fadeIn();this.$title.fadeIn()}hide(){this.$valCell.hide();this.$title.hide()}set(s){if(this.val&&this.val!=s){let t=s-this.val;let e=n("<span/>").html((t>0?"+":"")+t+"");e.appendTo(this.$valCell).addClass("ate-val-rise").css("color",t<0?"red":"green").animate({opacity:0,top:"-3em"},2e3,()=>{e.remove()})}this.val=s;this.$val.html(s+"");if(this.full){this.$rate.css("height",s/this.full*100+"%")}}}class k{constructor(t,e){this.$outer=n("<div/>").addClass(t);var s=n("<table/>").addClass("ate-info").appendTo(this.$outer);var i=n("<tbody/>").appendTo(s);this.$tr=n("<tr/>").appendTo(i);this.$th=n("<th/>").html(e).appendTo(this.$tr);this.health=null;this.magic=null;this.attack=null;this.defence=null;this.cm=null;this.gunHealth=null;this.chaos=null;this.rules=null}add(t,e,s,i,a){var h=new b(e,this,i,s);if(a){h.hide()}this[t]=h;return this}appendTo(t){this.$outer.appendTo(t);return this}remove(){this.$outer.remove();return this}}class ${constructor(t){this.game=t;this.values=localStorage.ateSettings?JSON.parse(localStorage.ateSettings):{speed:1500,pass:false,random:false,playwhenhidden:false};this.opened=false;this.hidden=true;this.$element=n(".ate-settings").hide();this.$cover=n("<div/>").addClass("ate-cover").appendTo(this.game.$interface).hide();this.$tags=n(".ate-settings-tag");this.$pages=n(".ate-settings-page");this.index=0;console.log(1);this.$tags.each((t,e)=>{let s=n(e);s.on("click",()=>{if(t===this.index){return}this.$tags.eq(this.index).removeClass("ate-settings-tag-show");this.$pages.eq(this.index).removeClass("ate-settings-page-show");this.index=t;this.$tags.eq(t).addClass("ate-settings-tag-show");this.$pages.eq(t).addClass("ate-settings-page-show")})});for(let s of["pass","random","playwhenhidden"]){let t=n("#ate-settings-"+s);let e=this.get(s);if(e){t.addClass("ate-button-on")}t.html(e?"是":"否").on("click",()=>{e=!e;this.toggle(s);t.html(e?"是":"否").toggleClass("ate-button-on")})}console.log(2);n("#ate-settings-clear").on("click",()=>{delete localStorage.gameData;this.game.notify("存档已清除！")});this.$export=n("#ate-export");this.$doneButton=n(".ate-settings-done");this.$speed=n("#ate-settings-speed").val(this.get("speed"))}get(t){return this.values[t]}set(t,e){this.values[t]=e;localStorage.ateSettings=JSON.stringify(this.values)}toggle(t){this.set(t,!this.get(t))}open(){if(!this.hidden){return}this.opened=true;this.hidden=false;var s=btoa(localStorage.gameData||"");this.$export.val(s);this.$doneButton.one("click",()=>{if(!this.opened){return}this.opened=false;const t=this.$speed.val();if(typeof t!=="string"){throw new Error("$speed.val() is a str")}if(t.match(/^\d+$/)){this.set("speed",parseInt(t))}const e=this.$export.val();if(typeof e!=="string"){throw new Error("$sxport.val() is a str")}if(e!==s){try{localStorage.gameData=atob(e)}catch(t){this.game.notify("存档不合法！")}}this.$element.animate({left:"-100%"},3e3,()=>{this.$element.hide();this.hidden=true});this.$cover.hide()});if(this.game.chapterGame&&this.game.chapterGame.history){var e=n(".ate-history").html("");for(let t of this.game.chapterGame.history){n("<li/>").html(t).appendTo(e)}}this.$cover.show();this.$element.css("left","").show()}}class C{constructor(){this.taskTracks=[];this.processing=false;this.stack=[]}push(t,e){if(e.dead||!this.stack.includes(e)){return}this.taskTracks[this.stack.indexOf(e)].push(t);if(!this.processing){this.process()}}process(){if(this.processing){return}var s=this.owner;var t=this.ownerIndex;var i=this.taskTracks[t];this.processing=true;const a=()=>{if(this.processing==false){return}if(s!==this.owner){this.processing=false;return this.process()}if(i.length===0){this.processing=false;return}let t=i.shift();console.log(t,s);let e=t.call(undefined);if(e&&e.done instanceof Function){e.done(a)}else{a()}};a()}give(t){if(t.dead){return}this.stack.push(t);this.taskTracks.push([]);if(!this.processing){this.process()}}get owner(){return this.stack[this.ownerIndex]}get ownerIndex(){return this.stack.length-1}}class y{constructor(t,e){this.queue=t;this.chapterGame=this instanceof G?this:e;this.dead=false}choose(t,e,s){this.wait(()=>this.chapterGame._choose(t,e,s))}wait(e){if(typeof e==="function"){this.queue.push(e,this)}else{this.queue.push(()=>{var t=n.Deferred();setTimeout(()=>t.resolve(),e);return t},this)}return this}die(){this.dead=true;this.queue.stack.pop();this.queue.taskTracks.pop();this.queue.process()}waitDie(){this.wait(()=>this.die())}log(s){this.wait(()=>{var t=n("<span/>").html(s).css("display","none");var e=n.Deferred();this.chapterGame.$message.scrollTop(this.chapterGame.$message[0].scrollHeight);this.chapterGame.$message.append(t).append("<br>");if(this.chapterGame.root.settings.get("speed")===0){t.show();this.chapterGame.$message.one("click",()=>e.resolve())}else{t.fadeIn(this.chapterGame.root.settings.get("speed"),()=>e.resolve())}this.chapterGame.history.push(s);return e})}waitTriggerEvent(t,e,s){var i=n.Deferred();if(s){t.one(e,()=>i.resolve())}else{t.on(e,()=>i.resolve())}this.wait(()=>i);return this}waitFadeOutEle(t){var e=n.Deferred();this.wait(()=>t.fadeOut(()=>e.resolve()));this.wait(()=>e);return this}}class E extends y{constructor(t,e){super(e.queue,e);this.func=t}go(){this.chapterGame.queue.give(this);this.func(this)}}class x{constructor(t,e,s,i){this.game=e;var a=l.items[t];this.id=t;this.name=a.name;this.description=a.description;this.stackable=a.stackable;this.throwable=a.throwable;if("battle"in a&&a.battle){this.battle=true;this.use=a.use;if("cd"in a){this.cd=a.cd}this.type=x.BATTLE}else if("attack"in a){this.attack=a.attack;if("magic"in a){this.magic=a.magic}this.type=x.WEAPON}else if("defence"in a){this.defence=a.defence;if("dodgeRate"in a){this.dodgeRate=a.dodgeRate}this.type=x.ARMOR}else{this.type=x.NORMAL}this.loadUI(s);if(this.stackable){this.amount=i}}get amount(){return this._amount}set amount(t){if(this.id===p){this.game.defence+=t-this._amount}if(t===0){this.game.removeItem(this);return}this.$descriptionAmount.html(t+"");this.$amount.html(t===1?"":t+"");this._amount=t}loadUI(t){this.$element=t;t.html("");this.game.addImage(t,this);t.append(n("<span/>").addClass("ate-item-name").html(this.name));var e=n("<span/>").addClass("ate-item-description").appendTo(t);var s=n("<div/>").html(this.description).appendTo(e);console.log("test",t,e);if(this.stackable){this.$amount=n("<span/>").addClass("ate-item-amount").appendTo(this.$element);this.$descriptionAmount=n("<span/>");s.append("<br>你有").append(this.$descriptionAmount).append("个")}if(this.type==x.ARMOR&&this.game.armor!==this||this.type==x.WEAPON&&this.game.weapon!==this){var i=I.button("装备").appendTo(s);i.on("click",()=>{this.game.equip(this)})}if(this.throwable!=false){I.button("丢弃").appendTo(s).on("click",()=>{if(this.game.armor!==this&&this.game.weapon!==this){this.game.removeItem(this)}})}}}x.NORMAL=0;x.BATTLE=1;x.WEAPON=2;x.ARMOR=3;class A extends y{constructor(t,e,s){super(e.queue,e);console.log(this);e.queue.give(this);this.tutorial=t.tutorial;this.withXk=t.withXk;this.withNc=t.withNc;this.withSo=t.withSo;this.octahedron=t.octahedron;this.cureMagicCost=this.chapterGame.has(r)?50:30;this.cureMagicPlus=this.chapterGame.has(r)?80:40;this.$element=e.$battle;this.after=s;this.deferredCommands={};this.won=false;this.afterWin=t.win;this.$element.children().fadeOut();var i=t.enemy;if(Array.isArray(i)){this.multiEnemy=true}else{i=[i]}this.aliveEnemyAmount=i.length;this.enemy=[];for(let s of i){let t=l.enemy[s];let e=new T(t,this);this.enemy.push(e)}for(let t of this.enemy){t.init()}this.zeroTable=new k("ate-zero-table","Zero").appendTo(this.$element);this.zeroTable.add("magic","魔法值",100,"purple");this.chapterGame.toggleExpand();this.magic=0;this.rounds=0;this.intenseFight=null}win(){if(this.won){return}this.won=true;this.chapterGame.goProcess(t=>{t.log("您获胜了！");if(this.afterWin){for(let t of this.afterWin){this.chapterGame.execute(t)}}this.chapterGame.toggleExpand();setTimeout(()=>{this.zeroTable.remove()},2e3);this.$element.children().fadeIn();t.wait(()=>{t.die();this.die()})})}run(){if(this.tutorial){this.roundEndCallback=[];this.log("星空说：“让我描述详细一点吧，在魔法系统下，战斗就是我们的【魔法核心】相互接触的过程，每个人都有一个【魔法核心】，只不过大多数人都不会用罢了，我来教你怎么使用。");this.log("星空跟你详细说明了使用魔法核心的方法，你试了一下，突然你感觉世界一下就改变了！");this.log("星空：现在我们进入了战斗界面！当你听完我的这些话后，就可以加入战斗了。战斗分为准备阶段和对战阶段，在准备阶段时，你可以尝试A【物品】、B【防御】、C【魔法】、D【跳过】，不过你现在没有魔法值，没有物品，选择【防御】吧。");this.choose(["防御","跳过"],t=>this.prepare(t))}else{this.round()}}round(){this.log("回合"+(this.rounds+1));this.defense=false;this.battleMagic=false;this.ncChipMagic=0;this.soSweaterMagic=0;this.heavyAttack=false;this.fightTimes=1;this.breakHarm=false;this.frozenBreadUsed=false;this.roundEndCallback=[];if(this.deferredCommands[this.rounds]){for(let t of this.deferredCommands[this.rounds]){this.chapterGame.execute(t,this)}}if(this.chapterGame.armor&&this.chapterGame.armor.id===o){this.chapterGame.execute("health + [3,20]")}for(let e of this.enemy){e.round();if(e.message){let t=e.message;if(typeof t[0]!=="string"){t=this.chapterGame.judgeArr(t)}let s=Math.floor(Math.random()*(t.length+1));if(s<t.length){let e=t[s].split(";");for(let t of e){if(t.startsWith("/")){this.chapterGame.execute(t.slice(1),this)}else{this.log(t)}}}}}this.wait(()=>this.prepareChoose())}prepareChoose(){this.choose(["物品","防御","魔法","跳过"],t=>this.prepare(t))}prepare(t){if(this.tutorial){if(t===0){this.defense=true;this.log("星空：很好，让我们试一下战斗吧！");this.log("星空：现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！因为我们点击了防御，我们无法对敌人造成伤害，但攻击可以增加魔法值！");this.choose(["DDDDD","你在教我做事？"],t=>this.fight(t))}else if(t===1){this.log("星空：你……不选防御吗？那也挺好。");this.log("星空：总之，现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！");this.choose(["DDDDD","你在教我做事？"],t=>this.fight(t))}else{throw new Error("Invalid Input.")}return}switch(t){case 0:if(this.enemy[0].id===6&&Math.random()<.5){this.log("四面体向你的背包里发射了一颗能量球，你受到了15点伤害！");this.chapterGame.health-=15}let s=[];for(let e in this.chapterGame.items){let t=this.chapterGame.items[e];if(t.battle){s.push(parseInt(e))}}if(s.length===0){this.log("你没有可用的物品。");return this.prepareChoose()}this.log("选择一项物品。");this.chapterGame.waitProcess(this,e=>{for(let t of s){this.chapterGame.$items.children().eq(t).css("boxShadow","2px 2px 4px 4px #66ccff").on("click",()=>{if(this.enemy[0].id===8&&this.chapterGame.items[t].id===m){this.chapterGame.achieve(4)}this.chapterGame.use(t,this);this.chapterGame.$items.children().css("boxShadow","").off("click");e.waitDie()})}});if(this.enemy[0].id===T.LORCE){this.rules+=f(2,5)}break;case 1:this.log("你选择了防御。");this.defense=true;this.magic+=40;break;case 2:if(this.magic===0||!this.octahedron&&this.magic<this.cureMagicCost){this.log("你的魔法值不够！");return this.prepareChoose()}if(this.enemy[0].id===17){this.magicChooseForLorce();break}this.magicChoose();break;case 3:this.log("你选择了跳过。")}if(this.enemy[0].id===14&&!this.defense){if(this.chaoAttacked==false&&(this.chaos>=85||this.enemy[0].health<=1400)){this.log("混沌持续上升！战斗已经进入白热化！");this.log("现在，你需要独自一人面对考验");this.log("J12132正在释放一次“混沌冲击！”");this.withXk=false;this.octahedron=false;this.chaoAttacked=true;this.fightTimes=2;this.enemy[0].attack+=5;this.chapterGame.virtually(12133);this.roundEnd(()=>{this.enemy[0].attack-=5})}else{switch(Math.floor(Math.random()*4)){case 0:this.log("小丑使用了“红心治疗”！");this.chapterGame.waitChoose(this,["进攻","诅咒"],t=>{if(t==0){this.chaos+=f(3,5);this.enemy[0].health+=f(10,50)}else{this.log("你诅咒小丑的治疗法术，小丑的法术失效了！");this.chaos+=1}});break;case 1:this.log("小丑使用了“草花守护”！");this.chapterGame.waitChoose(this,["进攻","打散"],t=>{if(t==0){this.chaos+=f(3,4);let t=this.chapterGame.attack;this.chapterGame.attack=0;this.roundEnd(()=>this.chapterGame.attack=t)}else{this.log("你用力向草花打去");this.chaos+=2}});break;case 2:this.log("小丑使用了“方块箭矢”！");this.chapterGame.waitChoose(this,["进攻","格挡"],t=>{if(t==0){this.chaos+=2;this.chapterGame.health-=f(5,35)}else{this.log("你尽可能地格挡箭矢的进攻");this.chaos+=f(1,5);this.chapterGame.attack-=10;this.roundEnd(()=>this.chapterGame.attack+=10)}});break;case 3:this.log("小丑使用了“黑桃炸弹”！");this.chapterGame.waitChoose(this,["进攻","闪躲"],t=>{if(t==0){this.chaos+=f(2,3);this.enemy[0].attack+=5;this.roundEnd(()=>this.enemy[0].attack-=5)}else{this.log("你拼命闪躲着炸弹，你的防御增加了！同时攻击减少了");this.chaos+=f(3,5);this.chapterGame.defence+=10;this.chapterGame.attack-=10;this.roundEnd(()=>this.chapterGame.defence-=10);this.roundEnd(()=>this.chapterGame.attack+=10)}});break}}}this.wait(()=>this.fightInput())}magicChoose(){this.log("你选择了魔法。");this.wait(200);let t=[`治疗魔法（${this.cureMagicCost}）`,"战斗魔法（70）",`黑暗魔法（${this.black?"100":"？"}）`];let i=[];if(this.octahedron){t.push(`几何八面体（${this.magic}）`);i.push(this.useOctahedron)}if(this.withNc){t.push(`${this.chapterGame.ncChip===1?"万能":"喵叫"}（40）`);i.push(this.useNcChip)}this.chapterGame.waitChoose(this,t,(t,e,s)=>{switch(t){case 0:if(this.magic<this.cureMagicCost){e.log("你的魔法值不够！");return s()}e.log(`你选择了治疗魔法，HP恢复${this.cureMagicPlus}`);this.magic-=this.cureMagicCost;this.chapterGame.health+=this.cureMagicPlus;break;case 1:if(this.magic<70){e.log("你的魔法值不够！");return s()}e.log(`你选择了战斗魔法，Att提高5，持续一回合。`);this.battleMagic=true;this.magic-=70;this.chapterGame.attack+=5;break;case 2:if(this.black){if(this.magic<100){e.log("你的魔法值不够！");return s()}e.log("水晶被黑暗笼罩住了！黑暗法术增强了！");this.magic=0;this.enemy[0].health=0}else{e.log("l͓̩̫̘͙͔̯͖̟̤̓͊̑̌́̂̆̚ò̥̪̭̱̰̝̒͂̄͋̿̏͆́̚c͍̲͇͚̖̬͈̪͙̳͌̉́̃k̪̥̱̝̱̑̈́̏̽͗̊̈́͂̀̍e̞͎̩̜̱̩͚̤̊͌̀̀d̠̖̞̝̙̪̟̞̐͛̈̊̀͂̄͌̓̏͌̓ͅ");return s()}break;case 3:case 4:i[t-3].call(this,e,s);break;default:throw new Error("非法输入")}return false})}magicChooseForLorce(){this.log("你选择了魔法。");this.wait(200);if(!this.talked){this.log("星空对你说：“罗尔斯的规则法术……好像对我们也有作用！”");this.talked=true}let t=["超级治疗（60）","规则防御（30）"];if(this.octahedron){t.push(`几何八面体（${this.magic}）`)}this.chapterGame.waitChoose(this,t,(e,s,i)=>{switch(e){case 0:if(this.magic<60){s.log("你的魔法值不够！");return i()}s.log("你试着用尽全力使出治疗法术……你的血量和攻击力增加了！");this.chapterGame.health+=80;this.chapterGame.attack+=5;this.battleMagic=true;this.magic-=60;break;case 1:if(this.magic<30){s.log("你的魔法值不够！");return i()}s.log("你使用了规则防御，罗尔斯的攻击降低了！罗尔斯的防御略微降低了！");this.magic-=30;this.enemy[0].attack-=10;this.roundEnd(()=>this.enemy[0].attack+=10);this.enemy[0].defence-=5;this.roundEnd(()=>this.enemy[0].defence+=5);break;case 2:let t=this.magic;this.magic=0;this.enemy[0].health-=t/2;s.log(`你选择了几何八面体，对【罗尔斯】造成${t/2}点伤害！`);break;default:throw new Error("非法输入")}this.rules+=f(3,7);return false})}useOctahedron(t,e){if(this.enemy[0].id===9){this.chapterGame.virtually(200)}let s=this.magic;this.magic=0;this.enemy[0].health-=s/2;t.log(`你选择了几何八面体，对【${this.enemy[0].name}】造成${s/2}点伤害！`)}useNcChip(t,e){if(this.magic<40){t.log("你的魔法值不够");return e()}if(this.chapterGame.ncChip===0){t.log("你使用了猫叫芯片!敌人发出了喵喵叫的声音");if(Math.random()<.2){t.log("喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵喵（")}this.ncChipMagic=1;this.enemy.forEach(t=>{let e=t.attack;t.attack=Math.floor(t.attack/2);this.roundEnd(()=>t.attack=e)})}else if(this.chapterGame.ncChip===1){t.log("你使用了万能芯片！请选择它的效果");this.chapterGame.waitChoose(t,["使对方本回合ATT变为原来的五分之一","使对方本回合受到伤害增加","使对方本回合只能打出相同的字母"],t=>{if(t===0){this.enemy.forEach(t=>{let e=t.attack;t.attack=Math.floor(t.attack/5);this.roundEnd(()=>t.attack=e)})}this.ncChipMagic=t+2})}}fightInput(e=0){if(e>=this.enemy.length){return this.finishRound()}if(this.enemy[e].dead){return this.fightInput(e+1)}this.wait(()=>{var s=new v(this.chapterGame,["A","B","C","D"],A.check5Capitals,t=>{s.remove();this.fight(t,e)});if(this.chapterGame.root.settings.get("random")){let e=[];for(let t=0;t<5;t++){e.push(65+Math.floor(Math.random()*4))}s.setValue(String.fromCharCode(...e))}})}static check5Capitals(e){if(e.length!==5){return false}for(let t=0;t<5;t++){if(!(65<=e.charCodeAt(t)&&e.charCodeAt(t)<=68)){return false}}return true}static computeHurtHarm(h,r,s,o,n,l,c,d,m){if(s<0){s=0}var p;if(m&&(m.enemy[0].id===4&&m.rounds%4==3||m.ncChipMagic==4)){p=Math.floor(Math.random()*4)}let u=0,f=0,g="";const v=c.root.$interface;for(let a=0;a<5;a++){let t=h.charCodeAt(a)-65,e=p||Math.floor(Math.random()*4),i=String.fromCharCode(e+65);if(t==e-1||t==3&&e==0){let t=r;let e=c.weapon;let s=l;if(!o&&e&&e.magic){if(m.magic>=c.weapon.magic){m.magic-=c.weapon.magic;if(e.id===w){s=0}}else{t-=c.weapon.attack}}t-=s;if(t<0||o){t=0}console.log("sigatt",t,"att",t,"sigedef",s,"bthis",r,"g.att",c.attack,"edef",l);f+=t;A.charWithColor(h.charAt(a),v,o?0:1,false,a*10+30+"%");A.charWithColor(i,v,-1,true,a*10+30+"%")}else if(e==t-1||e==3&&t==0){let t=false;if(d&&Math.random()<d){n=0;t=true}if(!o){n=0}if(n<s){u+=s-n}console.log(a,t,o);A.charWithColor(h.charAt(a),v,o?0:1,true,a*10+30+"%",o&&t);A.charWithColor(i,v,-1,false,a*10+30+"%")}else{A.charWithColor(h.charAt(a),v,o?0:1,true,a*10+30+"%");A.charWithColor(i,v,-1,true,a*10+30+"%")}g+=i}return[u,g,f]}static charWithColor(t,e,s,i,a,h){var r=n("<span/>").html(t).css("color",u[t]).appendTo(e);r.css({fontSize:"3em",position:"fixed",display:"block",left:a,fontWeight:"bold",userSelect:"none"});let o;if(s===1){o="self-"}else if(s===0){o="self-defense-"}else if(s===-1){o="enemy-"}if(h){o+="broken"}else if(i){o+="failed"}else{o+="success"}r.css("animation",`ate-char-${o} 4s linear`);r.css("--char-color",u[t]);window.setTimeout(()=>r.remove(),3800);return r}fight(r,o=0){let n=this.enemy[o];if(this.tutorial&&typeof r==="number"){if(r===0){this.magic+=40;this.log("星空：太棒了，现在我们有足够的魔法值来使用魔法了，试一下【魔法】吧，它会给你带来增益效果！剩下的你就自己摸索吧")}else{this.log("星空：呃……你没有听我的，看来你是想自己对战了，那我就不打扰你了！我先给你个治疗法术吧！");this.chapterGame.execute("health + 240")}this.tutorial=false}else if(typeof r==="string"){let t=Math.random()<n.defenseRate;let e=this.chapterGame.weapon;let s=t?n.defence:0;const l={13:.3,17:.6};let[i,a,h]=A.computeHurtHarm(r,this.chapterGame.attack,n.attack,this.defense,this.chapterGame.defence,s,this.chapterGame,l[n.id]||0,this);if(this.frozenBreadUsed||this.chapterGame.dodgeRate&&Math.random()<=this.chapterGame.dodgeRate){i=0}if(this.ncChipMagic===3){h*=2}this.log(`你的攻击是${r}，对方的攻击是${a}`);if(t){this.log(`${n.name}选择了防御。`)}this.log(`你受到${i}点伤害`);this.chapterGame.health-=i;this.log(`你造成了${h}点伤害`);n.health-=h;if(this.withXk){let t=s<20?20-s:0;this.log(`星空造成了${t}点伤害`);n.health-=t}this.fightTimes--;if(this.fightTimes>0){return this.fightInput()}if(this.multiEnemy&&o+1!==this.enemy.length){return this.fightInput(o+1)}if(n.fixed&&this.heavyAttack&&h>0){this.log("你朝炮筒攻打过去，机械木马开始松动了");n.gunHealth--}}this.finishRound()}finishRound(){if(this.battleMagic){this.chapterGame.attack-=5}for(let t of this.roundEndCallback){t.call(this.chapterGame)}if(!this.won){this.rounds++;this.round()}}get magic(){return this._magic}set magic(t){if(t>100){t=100}this._magic=t;this.zeroTable.magic.set(t)}get chaos(){return this._chaos}set chaos(t){this._chaos=t;this.enemy[0].table.chaos.set(t);if(this.chaos>=100){this.log("混沌盘旋着毁灭了战场，你胜利了。");this.chapterGame.virtually(12132);this.win()}}get rules(){return this._rules}set rules(t){this._rules=t;this.enemy[0].table.rules.set(t);if(t>=100){this.log("战斗的规则摇晃着崩塌了");this.win()}}roundEnd(t){this.roundEndCallback.push(t)}get black(){return this.chapterGame.judge(1024)&&this.enemy[0].id===9}}class T{constructor(t,e){this.id=t.id;this.battle=e;this.game=e.chapterGame;this.table=new k("ate-enemy-table",t.name).appendTo(this.battle.$element);this.table.add("health","HP",t.health,"red");this.name=t.name;this.full=t.health;this.health=t.health;this.attack=t.attack;this.defence=t.defence;this.defenseRate=t.defenseRate;this.message=t.message;this.dead=false}init(){switch(this.id){case 13:this.table.add("gunHealth","炮筒",5,"orange",true);this.gunHealth=5;this.fixed=false;break;case 14:this.table.add("chaos","混沌",120,"linear-gradient(red, grey)",true);this.table.chaos.show();this.battle.chaos=0;this.battle.chaoAttacked=false;break;case 17:this.table.add("rules","规则度",100,"linear-gradient(orange, grey)",true);this.battle.rules=0;this.battle.talked=false;this.battle.intenseFight=false;break;default:break}}get health(){return this._health}set health(t){if(this.dead){return}this._setHealth(t);if(this.id===13){if(t<=0){this.battle.log("木马的血条似乎空了……但不要以为【自我修复】的力量就这点！");this.game.achieve(3);this._setHealth(this._health+200)}return}else if(this.id===14){if(t<=0){this.battle.win()}}if(t<=0){this.table.remove();this.battle.aliveEnemyAmount--;this.dead=true;if(this.battle.aliveEnemyAmount===0){this.battle.win()}}}_setHealth(t){this._health=t;this.table.health.set(t)}get gunHealth(){return this._gunHealth}set gunHealth(t){if(t<=0){this.battle.log("机械木马剧烈地抖动！你胜利了！");this.battle.win()}this._gunHealth=t;this.table.gunHealth.set(t)}round(){switch(this.id){case T.WHEEL:if(Math.random()<.25){this.battle.log("滚轮扬起的烟尘让你睁不开双眼！你的攻击力降低了！");this.game.attack-=10;this.battle.roundEnd(()=>this.game.attack+=10)}break;case T.CRD:if(this.battle.rounds===9){this.battle.log("CRD：“什么？！你们居然还能挺得住，看来我要动用增援了！”");this.battle.log("第一个短矛向你袭来");this.game.waitBattle(8,this.battle);this.battle.log("第二个短矛向你袭来");this.game.waitBattle(8,this.battle);this.battle.log("你转过头来，继续对战CRD。");this.battle.wait(()=>void this.game.toggleExpand())}break;case T.SHORT_SPEAR:if(this.battle.rounds===6){this.game.achieve(2)}break;case T.DEER_FALSE:case T.DEER_TRUE:if(this.battle.rounds%5===4){this.battle.log("鹿法师使用了火魔法！ATT暂时提升5点");this.attack+=5;this.battle.roundEnd(()=>this.attack-=5)}break;case T.MECHANIC_HORSE:if(this.health<400){this.battle.log("机械木马的HP降低了！");this.battle.log("机械木马使用了【自我修复】！机械木马的HP回升了70点！");if(this.fixed==false){this.battle.log("“呃……这样真的能击败它吗？”水晶说道。");this.battle.log("“Zero就不能用点什么手段吗……”一个骷髅抱怨道。");this.battle.log("“呃……对了！我看到这个木马的炮管，在平常的时候好像都是掩着的，说不定这就是它的弱点！Zero，它等下发动炮弹攻击的时候，你向炮管打去，看看会怎么样！”水晶说。");this.table.gunHealth.show();this.fixed=true}this.health+=70}if(this.battle.heavyAttack=this.battle.rounds%5===4){this.battle.log("机械木马正在准备一发重型火力攻击。");this.attack+=20;this.battle.roundEnd(()=>this.attack-=20)}else if(this.battle.rounds%5===0&&this.battle.rounds>0){this.battle.log("机械木马正在准备一发散弹攻击！");this.fightTimes=2}break;case T.LORCE:if(this.battle.rounds%4==1&&!this.withXk){this.withXk=true;this.octahedron=true;this.battle.log("星空恢复了过来。")}let t=.1;if(this.battle.intenseFight==true){t*=2}if(this.battle.defense){t*=2}if(this.battle.breakHarm=Math.random()<t){this.battle.log("罗尔斯举起了重剑！罗尔斯的攻击力提高了！");this.attack+=10;this.battle.roundEnd(()=>this.attack-=10);this.breakHarm=true}if(Math.random()<t){let t=f(10,35);this.game.health-=t;this.battle.log(`罗尔斯使用了一发扑克散弹,你受到了${t}点伤害！`)}if(Math.random()<t){this.battle.log("罗尔斯使用重剑劈晕了星空！");this.withXk=false;this.octahedron=false}this.attack+=5;this.battle.roundEnd(()=>this.attack-=5);break;default:break}}}T.WHEEL=5;T.CRD=7;T.SHORT_SPEAR=8;T.DEER_FALSE=10;T.DEER_TRUE=11;T.MECHANIC_HORSE=13;T.LORCE=17;class G extends y{constructor(t,e,s){super(t);t.give(this);this.root=e;this.chapter=s;this.$grid=n("<div/>").addClass("ate-grid").appendTo(this.root.$interface);this.$status=n("<div/>").addClass("ate-status").appendTo(this.$grid);this.$save=I.button("保存").on("click",()=>this.save()).appendTo(this.root.$buttons);this.$shopMagic=I.button("商店").on("click",()=>this.shopMagic()).appendTo(this.root.$buttons).hide();n(document).on("keypress",t=>{t.which===89&&this.shopMagic()});this.table=new k("ate-vals","状态栏").appendTo(this.$status);this.$items=n("<div/>").addClass("ate-items").appendTo(this.$status);this.$equipments=n("<div/>").addClass("ate-equipments").appendTo(this.$status);this.$message=n("<div/>").addClass("ate-messages").appendTo(this.$grid);this.$battle=n("<div/>").addClass("ate-battle").appendTo(this.$grid);this.$input=n("<div/>").addClass("ate-input").appendTo(this.$grid);this.$choices=n("<div/>").addClass("ate-choices").appendTo(this.$grid);this.$weapon=n("<div/>").addClass("ate-item").appendTo(this.$equipments);this.$armor=n("<div/>").addClass("ate-item").appendTo(this.$equipments);this.$weapon.append(n("<span/>").addClass("ate-item-name").html("武器"));this.$armor.append(n("<span/>").addClass("ate-item-name").html("防具"));this.table.add("health","HP",l[this.chapter].maxHealth,"green");this.table.add("attack","Att");this.table.add("defence","Def");this.table.add("cm","CM币");this.max=l[this.chapter].maxItems;for(let t=0;t<this.max;t++){n("<div/>").addClass("ate-item").appendTo(this.$items)}this.dead=false;this.attack=15;this.defence=0;this.dodgeRate=0;var i=window.localStorage;if(i.gameData){this.storage=JSON.parse(i.gameData);this.health=this.storage.health;this.items=[];this.experience=this.storage.experience;this.stackables=this.storage.stackables;var a=this.storage.items;if(this.storage.weapon){this.weapon=new x(this.storage.weapon,this,this.$weapon,1);a.splice(a.indexOf(this.storage.weapon),1)}if(this.storage.armor){this.armor=new x(this.storage.armor,this,this.$armor,1);a.splice(a.indexOf(this.storage.armor),1)}for(let t of a){this.add(t,this.stackables[t])}this.cm=this.storage.cm;this.shops=this.storage.shops||[];this.virtualExperience=this.storage.virtual||[];this.ncChip=this.storage.ncChip||0;this.soSweater=this.storage.soSweater||0}else{this.storage={};this.health=l[this.chapter].maxHealth;this.cm=0;this.experience=[];this.stackables={};this.items=[];this.shops=[];this.virtualExperience=[];this.ncChip=0;this.soSweater=0}if(this.shops.length>0){this.$shopMagic.show()}this.R=Math.round(Math.random()*100)+1;this.history=[];this.exp(this.experience.length?this.experience.pop():0)}die(){[this.$grid,this.$shopMagic,this.$save].forEach(t=>t.remove());super.die();delete this.chapterGame}showItems(s){var i=[],a=[];var h=this.items;for(let e in h){let t=h[e];if(t.throwable!==false||!s){i.push(t.name);a.push(parseInt(e))}}return[i,a]}equip(t){this.items.splice(this.items.indexOf(t),1);if(t.type===x.WEAPON){this.weapon=t}else if(t.type===x.ARMOR){this.armor=t}else{throw new Error("不可佩戴")}}get attack(){return this._attack}set attack(t){this._attack=t;if(this.weapon&&this.weapon.id===c){this.table.attack.$val.html("?");return}this.table.attack.set(t)}get defence(){return this._defence}set defence(t){this._defence=t;this.table.defence.set(t)}get cm(){return this._cm}set cm(t){this._cm=t;this.table.cm.set(t)}get health(){return this._health}set health(t){if(this._health<0&&t<0){return}if(t>l[this.chapter].maxHealth){t=l[this.chapter].maxHealth}else if(t<=0){this.deadInterface()}this._health=t;this.table.health.set(t)}get weapon(){return this._weapon}set weapon(t){if(!t||t===this.weapon){return}var e=this.weapon;this._weapon=t;if(e){if(e.id===c){window.clearInterval(this.timer.id);this.attack-=this.timer.lastAdd}else{this.attack-=e.attack}e.$element.insertBefore(this.findBlankItem());this.items.push(e)}else if(t.$element!==this.$weapon){this.$weapon.html("").appendTo(this.$items)}t.$element.prependTo(this.$equipments);if(t.id===c){this.timer={};this.timer.lastAdd=0;this.timer.id=window.setInterval(()=>{this.attack-=this.timer.lastAdd;this.timer.lastAdd=f(5,50);this.attack+=this.timer.lastAdd},5e3)}else{this.attack+=t.attack}}get armor(){return this._armor}set armor(t){if(!t||t===this.armor){return}var e=this._armor;this._armor=t;if(e){this.defence-=e.defence;if(e.dodgeRate){this.dodgeRate-=e.dodgeRate}e.$element.insertBefore(this.findBlankItem());this.items.push(e)}else if(t.$element!==this.$armor){this.$armor.html("").appendTo(this.$items)}t.$element.appendTo(this.$equipments);this.defence+=t.defence;if(t.dodgeRate){this.dodgeRate+=t.dodgeRate}}findItem(e){if(e===undefined){return undefined}for(let t of this.items){if(t.id===e){return t}}}waitGet(i,a=1,t=this){const e=()=>{if(this.itemsFull(i)){this.wait(()=>{var[t,s]=this.showItems(true);t.push("放弃拾取");this.goProcess(e=>{e.log("已满，请丢弃一项");e.choose(t,t=>{if(t===this.max){return e.die()}this.remove(s[t]);this.add(i,a);e.die()})})})}else{var e=this.add(i,a);this.waitProcess(t,t=>{t.log(`已将${e.name}加入您的背包。`);t.waitDie()})}};var s=this.findItem(i);if(s&&s.stackable){s.amount+=a}else{e()}}findBlankItem(){var t=this.$items.children(".ate-item");var i;t.each((t,e)=>{var s=n(e);if(s.html()==""){i=s;return false}});if(!i){throw new Error("没有找到空位")}return i}itemsFull(t){var e;if(t!==undefined){e=l.items[t].stackable}return this.items.length===this.max&&!(e&&this.has(t))}add(t,e){var s=new x(t,this,this.findBlankItem(),e);this.items.push(s);return s}has(t){return!!this.findItem(t)}remove(t){var e=this.items.splice(t,1)[0];e.$element.html("").css("backgroundImage","").appendTo(this.$items);return e}waitRemove(t,e=this){e.wait(()=>void this.remove(t))}removeItem(t){return this.remove(this.items.indexOf(t))}waitRemoveItem(t,e=this){e.wait(()=>void this.removeItem(t))}use(t,e){var s=this.items[t];if(s.stackable){s.amount-=1}else{this.waitRemove(t,e)}e.log(`你使用了${s.name}。`);if(s.id===d){e.frozenBreadUsed=true}for(let t of s.use){this.execute(t,e)}}exp(t){this.cache();this.$message.html("");this.experience.push(t);const e=l[this.chapter].story[t];if(Array.isArray(e)){this.story(this.judgeArr(e))}else{this.story(e)}}story(h){for(let e of h.message){let t;if(typeof e==="string"){t=e}else if(Array.isArray(e)){t=this.judgeArr(e);if(!t){continue}}if(t.startsWith("/")){this.execute(t.slice(1))}else if(t.endsWith("/")){this.log(t.slice(0,-1))}else{this.log(t)}}if("battle"in h){this.waitBattle(h.battle,this)}if("choice"in h){if("to"in h){let e=h.choice.length;let i=[];let a=[];for(let t=0;t<e;t++){let e=h.choice[t];let s=h.to[t];if(typeof e==="string"){i.push(e);a.push(s)}else if(Array.isArray(e)){let t=this.judgeArr(e);if(t){i.push(t);a.push(s)}}}this.choose(i,t=>{const e=a[t];if(typeof e==="number"){this.exp(e)}else if(Array.isArray(e)){this.exp(this.judgeArr(e))}},h.fadeChoice)}else{this.wait(()=>{this.toggleExpand();let s=new v(this,[],t=>"#pattern"in h.choice?new RegExp(h.choice["#pattern"]).test(t):true,t=>{if(!("#default"in h.choice)){if(t in h.choice){const e=h.choice[t];if(typeof e==="number"){this.exp(e)}else if(Array.isArray(e)){this.exp(this.judgeArr(e))}}else{return}}else{const e=h.choice[t in h.choice?t:"#default"];if(typeof e==="number"){this.exp(e)}else if(Array.isArray(e)){this.exp(this.judgeArr(e))}}s.remove();this.toggleExpand()})})}}else{const t=h.to;if(!this.root.settings.get("pass")){this.wait(()=>{var t=n.Deferred();this.$message.append(n("<span/>").html("点按以继续").css("font-size","50%"));this.$message.one("click",()=>t.resolve());return t})}if(typeof t==="number"){this.wait(()=>this.exp(t))}else if(Array.isArray(t)){this.wait(()=>this.exp(this.judgeArr(t)))}else if(t===true){this.experience=[];this.chapter++;this.root.chapter++;this.health=l[this.chapter].maxHealth;this.cache();this.save();this.wait(()=>this.root.chooseChapter());this.waitDie()}else{this.log("敬请期待！")}}}execute(t,i){var a=t.split(" "),h;switch(a[0]){case"get":this.waitGet(parseInt(a[1]),a[2]&&parseInt(a[2]));break;case"remove":this.removeItem(this.findItem(parseInt(a[1])));break;case"health":case"cm":h=g(a[2]);if(a[1]=="+"){this[a[0]]+=h}else if(a[1]=="-"){this[a[0]]-=h}break;case"attack":case"defence":case"dodgeRate":h=g(a[2]);let t=a[3]==="true"||a[3]==="1";if(i&&t){if(a[1]=="+"){this[a[0]]+=h;i.after.wait(()=>this[a[0]]-=h)}else if(a[1]=="-"){this[a[0]]-=h;i.after.wait(()=>this[a[0]]+=h)}}else if(i){if(a[1]=="+"){this[a[0]]+=h;i.roundEnd(()=>this[a[0]]-=h)}else if(a[1]=="-"){this[a[0]]-=h;i.roundEnd(()=>this[a[0]]+=h)}}else{if(t){console.warn("No battle. Don't use the third argument [untilEnd].")}if(a[1]=="+"){this[a[0]]+=h}else if(a[1]=="-"){this[a[0]]-=h}}break;case"harm":if(a[2]=="1"&&i.aliveEnemyAmount>1){this.goProcess(e=>{e.log("选择一个使用对象。");for(let t of i.enemy){t.table.$outer.on("click",()=>{t.health-=parseInt(a[1]);n(".ate-enemy-table").off("click");e.die()})}})}else{i.enemy.forEach(t=>!t.dead&&(t.health-=parseInt(a[1])))}break;case"dodge":this.dodge(parseInt(a[1]),a[2]);break;case"bridge":this.bridge();break;case"floor":this.floor();break;case"door":this.door(parseInt(a[1]),parseInt(a[2]));break;case"shop":this.waitShop(parseInt(a[1]));break;case"achieve":this.achieve(parseInt(a[1]));break;case"edefence":case"eattack":let e=a[0].slice(1);h=g(a[2]);if(a[1]=="+"){i.enemy[e]+=h;i.roundEnd(()=>i.enemy[e]-=h)}else if(a[1]=="-"){i.enemy[e]-=h;i.roundEnd(()=>i.enemy[e]+=h)}break;case"experience":this.virtually(parseInt(a[1]));break;case"defer":let s=i.rounds+parseInt(a[1]);i.deferredCommands[s]=i.deferredCommands[s]??[];i.deferredCommands[s].push(a.slice(2).join(" "));break;case"addshop":this.shops.push(parseInt(a[1]));if(this.$shopMagic.css("display")==="none"){this.$shopMagic.show()}break;case"sleep":break;default:throw new Error("Unknown Command")}}judge(e){if(typeof e==="number"){return this.experience.includes(e)}else if(typeof e==="string"){if(/^[0-9]+$/.test(e)){return this.experience.includes(parseInt(e))}let t;if(t=/^([\w\!\&\|]+?)\|([\w\!\&\|]+)$/.exec(e)){return this.judge(t[1])||this.judge(t[2])}if(t=/^([\w\!\&\|]+?)&([\w\!\&\|]+)$/.exec(e)){return this.judge(t[1])&&this.judge(t[2])}if(e.startsWith("!")){return!this.judge(e.slice(1))}if(t=/^([a-z]+)(\d+)$/.exec(e)){let s=t[1];let i=parseInt(t[2]);switch(s){case"r":return this.R===i;case"health":case"h":return this.health===i;case"item":case"i":return this.has(i);case"armor":case"a":let t=this.armor;return t!==undefined&&t.id===i;case"weapon":case"w":let e=this.weapon;return e!==undefined&&e.id===i;case"cm":case"c":return this.cm>=i;case"virtual":case"v":return this.virtualExperience.includes(i);case"attack":case"att":return this.attack>=i;case"defence":case"def":return this.defence>=i;default:throw new Error(`Illegal condition prefix '${s}'.`)}}}}static isValidCondition(t){return typeof t==="number"||/^[a-z0-9&\|!]+$/.test(t)}judgeArr(e){var s=e.length;if(!G.isValidCondition(e[1])){return e[f(0,s-1)]}var i;for(let t=0;t<s;t++){if(t===s-1){i=e[t];break}if(this.judge(e[t+1])){i=e[t];break}t++}return i}_choose(s,i,a){n(".ate-choices > *").hide();var h=n("<div/>").appendTo(this.$choices);for(let e in s){let t=n("<div/>").addClass("ate-choice").html(s[e]).appendTo(h);t.on("click",()=>{setTimeout(()=>h.remove());n(".ate-choices > *").show();i.call(s,parseInt(e))});if(a&&a.includes(parseInt(e))){t.css("opacity","0.05")}}h.append(I.clear())}cache(){var e=[];var s={};for(let t of this.items){e.push(t.id);if(t.stackable){s[t.id]=t.amount}}if(this.weapon){e.push(this.weapon.id)}if(this.armor){e.push(this.armor.id)}this.storage={health:this.health,items:e,experience:this.experience,weapon:this.weapon?this.weapon.id:null,armor:this.armor?this.armor.id:null,cm:this.cm,stackables:s,virtual:this.virtualExperience,chapter:this.chapter,ncChip:this.ncChip,soSweater:this.soSweater};this.saved=false}save(){this.saved=true;localStorage.gameData=JSON.stringify(this.storage);this.root.notify("保存成功")}waitBattle(e,s){s.wait(()=>{var t=new A(l.battle[e],this,s);t.run()})}dodge(r,o){this.waitProcess(this,a=>{this.toggleExpand();var h=new v(this,["A","B","C","D"],A.check5Capitals,t=>{h.remove();let[e,s,i]=A.computeHurtHarm(t,0,r,true,0,0,this);a.log(`你的攻击是${t}，${o}的攻击是${s}。`);a.log(`你被扣血${e}`);this.health-=e;a.wait(()=>this.toggleExpand());a.waitDie()});if(this.root.settings.get("random")){let e=[];for(let t=0;t<5;t++){e.push(f(65,68))}h.setValue(String.fromCharCode(...e))}})}bridge(t=false){var e=t?4:3;var h=t?"地板":"桥";this.log(`选择一${t?"条路线":"座桥"}以通过`);var r=[];for(let t=0;t<e;t++){r.push(String.fromCharCode(65+t))}this.waitChoose(this,r,(t,e,s)=>{var i=Math.floor(Math.random()*3);var a=Array.from(r);if(t===i){a.splice(i,1);e.log(`翻转地板组成了${h+a.join()}，你没通过${h}！[HP-2]`);this.health-=2;return s()}else{e.log(`你通过了${h}！`)}})}floor(){return this.bridge(true)}door(o,n){this.waitProcess(this,t=>{this.toggleExpand();var a=0;const h=()=>{if(o==5&&n==5&&a%3===0){return"00000"}else if(o==10&&n==10&&a%3===0){return Math.random()>.5?"1111111111":"0000000000"}let e="";for(let t=0;t<o;t++){e+=Math.random()>.5?"1":"0"}return e};var r=new v(this,["0","1"],t=>t.length===o&&!/[^01]/.test(t),e=>{let s=h();let i=0;for(let t=0;t<o;t++){if(s[t]!==e[t]){i++}}if(i>=n){t.log("你通过了升降门！");t.waitDie();r.remove();this.toggleExpand()}else{t.log(`升降门的升降形式是${s}，你只通过了${i}道门，请重新来过[HP-5]`);r.setValue("");this.health-=5}a++});t.log(`请输入您的通过方式，由${o}个二进制字符组成`);if(o!=n){t.log(`至少通过${n}/${o}道`)}})}shopMagic(){if(this.queue.ownerIndex!==1){return this.root.notify("现在不能使用商店魔法")}var s=[];if(this.shops.length<=0){this.log("你没有商店。");return}for(let e of this.shops){let t=l.shop[e];console.log(l.shop,l.shop[e],t);s.push(t.name)}this.goProcess(e=>{e.choose(s,t=>{this.waitShop(this.shops[t],e);e.waitDie()})})}waitShop(t,e=this){var s=l.shop[t];var o=s.price;e.log(`欢迎来到${"name"in s?s["name"]:"商店"}！`);const n=()=>this.goProcess(s=>{var i={},a=[],h=[];for(let e in o){let t=o[e];if(Array.isArray(t)){t=this.judgeArr(t);if(!t){continue}}i[e]=t;h.push(e);a.push(l.items[e].name+` [cost CM币${t}个]`)}console.log(i);var r=a.length;a.push("离开");s.choose(a,t=>{if(t===r){return s.die()}var e=parseInt(h[t]);console.log(e);if(this.itemsFull(e)){s.log("背包空间不够，你离开了商店");return s.waitDie()}if(i[e]>this.cm){s.log("你的CM币不够！")}else{this.cm-=i[e];this.waitGet(e,1,s)}s.waitDie();n()})});e.wait(()=>n())}virtually(t){this.virtualExperience.push(t)}deadInterface(){this.goProcess(e=>{e.log("黑暗再次降临。");if(this.has(i)){e.log("使用复活爱心吗?");e.choose(["是","否"],t=>{if(!t){this.findItem(i).amount--;this.health=100;e.log("那么，你将再次驱散黑暗");e.waitDie()}else{e.log("看来，黑暗将会再度笼罩你");e.log("You died.");delete localStorage.gameData;delete this.queue}})}else{e.log("希望似乎保佑不了你");e.log("看来，黑暗将会再度笼罩你");e.log("You died.");delete localStorage.gameData;delete this.queue}})}addImage(t,e){if(e instanceof x){e=e.id}if(e<this.root.itemImages.length){t.css("backgroundImage",`url(${this.root.itemImages[e]})`)}}achieve(t){if(this.achievements.includes(t)){return}var e=l.achievement[t];var s=n("<div/>").addClass("ate-achievement");this.root.$interface.append(s);n("<div/>").addClass("ate-achievement-title").html("成就："+e.name).appendTo(s);n("<span/>").addClass("ate-achievement-content").html(e.description).appendTo(s);s.animate({opacity:1,left:0},2e3);setTimeout(()=>s.fadeOut(3e3),12e3);this.achievements.push(t)}get achievements(){var e=localStorage.ateAchievements?JSON.parse(localStorage.ateAchievements):[];return{push(t){e.push(t);localStorage.ateAchievements=JSON.stringify(e)},includes(t){return e.includes(t)},get length(){return e.length}}}goProcess(t){return new E(t,this).go()}waitProcess(t,e){t.wait(()=>this.goProcess(e))}waitChoose(t,e,a){this.waitProcess(t,s=>{const i=()=>{s.choose(e,t=>{let e=a(t,s,i);if(e!==true){s.die()}});return true};i()})}toggleExpand(){let t=this.root.$interface.hasClass("ate-interface-expanded");if(t){this.root.$interface.removeClass("ate-interface-expanded")}else{this.root.$interface.addClass("ate-interface-expanded")}}}class I extends y{constructor(t){super(t);this.queue=t;t.give(this);this.$interface=n(".ate-interface");this.$buttons=n("<div/>").addClass("ate-buttons").appendTo(this.$interface);this.settings=new $(this);this.$settings=I.button("设置").on("click",()=>this.settings.open()).appendTo(this.$buttons);if(Element.prototype.requestFullscreen){let t=false;n(document).on("fullscreenchange",()=>{t=!t;this.$fullscreen.html(t?"退出全屏":"全屏模式")});this.$fullscreen=I.button("退出全屏").on("click",()=>{if(!t){document.documentElement.requestFullscreen({navigationUI:"hide"})}else{document.exitFullscreen()}}).appendTo(this.$buttons)}var e=n("<div/>").addClass("ate-white").insertAfter(this.$interface);var s=n("<div/>").addClass("ate-sw0rd").insertAfter(this.$interface).hide().fadeIn(1e3);this.wait(4e3).wait(()=>{e.remove();s.fadeOut(1e3)});var i=n("<div/>").addClass("ate-enter").html("Extend Air Ticket<div>Click to start</div>").insertAfter(this.$interface);this.waitTriggerEvent(i,"click",true).wait(()=>i.fadeOut(1e3)).wait(1e3).wait(()=>i.remove());var a=n("#author");a.on("click",()=>{a.hide()});n(document).one("click",()=>{const t=document.getElementById("music");if(t instanceof HTMLAudioElement){n(document).on("visibilitychange",()=>{if(document.visibilityState!=="visible"){if(!this.settings.get("playwhenhidden")){t.pause()}}else{t.play()}});t.play()}else{console.warn("未找到<audio>，无法播放。")}if(Element.prototype.requestFullscreen){document.documentElement.requestFullscreen({navigationUI:"hide"})}else if(Element.prototype.webkitRequestFullScreen){document.documentElement.webkitRequestFullScreen({navigationUI:"hide"})}});this.itemImages=[];for(let t of l.items){this.itemImages.push("./images/"+t.id+".png")}window.addEventListener("beforeunload",t=>{if(!this.chapterGame.saved){t.preventDefault();t.returnValue="";return""}});if(localStorage.gameData){this.storage=JSON.parse(localStorage.gameData);this.chapter=this.storage.chapter||1}else{this.chapter=1}this.chooseChapter()}static button(t,e){var s=n("<div/>").addClass("ate-button").html(t);if(e){if(e.cls){s.addClass("ate-button-"+e.cls)}if(e.title){s.attr("title",e.title)}if(e.margin){s.css("marginLeft",e.margin)}if(e.padding){s.css("paddingLeft",e.padding).css("paddingRight",e.padding)}if(e.color){s.css("backgroundColor",e.color)}}return s}chooseChapter(){var s=n("<div/>").addClass("ate-chapters").appendTo(this.$interface);for(let e=1;e<=5;e++){let t=n("<div/>").addClass("ate-chapter").appendTo(s);if(l[e]&&e==this.chapter){t.html("Chapter "+e);this.waitTriggerEvent(t,"click");this.waitFadeOutEle(t);this.wait(()=>{s.remove();this.chapterGame=new G(this.queue,this,this.chapter)})}else if(l[e]&&e<this.chapter){t.addClass("ate-chapter-passed").html("passed")}else{t.addClass("ate-chapter-locked").html("locked")}}}notify(t){var e=n("<div/>").addClass("ate-notification").appendTo(this.$interface).html(t);e.fadeIn(1500);e.fadeOut(3e3,()=>e.remove())}static clear(){return n("<div/>").css("clear","both")}}var D=new I(new C);document.title="游玩 Extend Air Ticket";n("#version").html(t)})(jQuery,ateData,"2.NaN");
