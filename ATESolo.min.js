"use strict";(function(c,d,e){class m{constructor(e){this.arrays={};this.indexes={};m.owners=[];m.newid(e);this.give(e)}push(e,t){if(t.dead||!this.arrays[t.id]){return}this.arrays[t.id].push(e);if(!this.processing){this.process()}}process(){if(this.processing){return}var t=this.owner;var s=this.arrays[t],i=this.indexes[t]||0,a=this;this.processing=true;function h(){if(a.processing==false){return}if(t!==a.owner){a.processing=false;a.indexes[t]=i;return a.process()}if(i>=s.length){a.arrays[t]=[];a.indexes[t]=0;a.processing=false;return}console.log(s[i]);let e=s[i++].call(undefined);if(e&&e.done){e.done(h)}else{h()}}h()}give(e){this.owner=e.id;if(!this.arrays[e.id]){this.arrays[e.id]=[]}if(!this.processing){this.process()}}static newid(e){if(m.curid===undefined){m.curid=0}m.owners.push(e);e.id=m.curid;m.curid++}now(){return m.owners[this.owner]}}class t{constructor(e,t){if(!t)throw Error("Missing argument game");m.newid(this);this.func=e;this.dead=false;this.game=t}go(){this.game.queue.give(this);this.func(this)}log(e){this.wait(()=>this.game._log(e))}wait(e){this.game.queue.push(e,this)}choose(e,t){this.wait(()=>this.game._choose(e,t))}die(e){this.dead=true;if(e)this.game.queue.give(e)}}class p{constructor(e,t,s){console.log(this);m.newid(this);t.queue.give(this);this.game=t;this.tutorial=e.tutorial;this.withXk=e.withXk;this.octahedron=e.octahedron;this.cureMagicCost=30;this.cureMagicPlus=40;this.$element=t.$battle;this.callback=s;this.$element.children().fadeOut();this.$enemy=c("<div/>").appendTo(this.$element);var i=c("<table/>").addClass("ate-info").appendTo(this.$enemy);var a=c("<tbody/>").appendTo(i);var h=c("<tr/>").appendTo(a);this.won=false;this.afterWin=e.win;var r=d.enemy[e.enemy];c("<th/>").html(r.name).appendTo(h);c("<td/>").html("HP").appendTo(h);this.$enemyHealth=c("<span/>").appendTo(c("<td/>").appendTo(h));this.$enemyHealthRate=c("<div/>").addClass("ate-info-rate").css({backgroundColor:"red",height:"100%"}).insertAfter(this.$enemyHealth);this.enemy=new f(r,this);this.$self=c("<div/>").appendTo(this.$element);var n=c("<table/>").addClass("ate-info").appendTo(this.$self);var o=c("<tbody/>").appendTo(n);var l=c("<tr/>").appendTo(o);this.$self.animate({marginTop:"6em"});this.game.$interface.addClass("battling");c("<th/>").html("Zero").appendTo(l);c("<td/>").html("魔法值").appendTo(l);this.$magic=c("<span/>").appendTo(c("<td/>").appendTo(l));this.$magicRate=c("<div/>").addClass("ate-info-rate").css({backgroundColor:"purple",height:"0"}).insertAfter(this.$magic);this.magic=0;this.rounds=0;if(this.enemy.id===4){this.special=0}}win(){if(this.won){return}this.won=true;this.log("您获胜了！");if(this.afterWin){for(let e of this.afterWin){this.game.execute(e)}}this.$self.animate({marginTop:"0"},2e3,()=>{this.game.$interface.removeClass("battling");this.$enemy.remove();this.$self.remove()});this.$element.children().fadeIn();this.wait(()=>{this.callback.call(this.game);this.dead=true})}log(e){this.wait(()=>this.game._log(e))}wait(t){if(typeof t==="function"){this.game.queue.push(t,this)}else{this.game.queue.push(()=>{var e=c.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}choose(e,t){this.wait(()=>this.game._choose(e,t))}run(){if(this.tutorial){this.roundEndCallback=[];this.log("星空说：“让我描述详细一点吧，在魔法系统下，战斗就是我们的【魔法核心】相互接触的过程，每个人都有一个【魔法核心】，只不过大多数人都不会用罢了，我来教你怎么使用。");this.log("星空跟你详细说明了使用魔法核心的方法，你试了一下，突然你感觉世界一下就改变了！");this.log("星空：现在我们进入了战斗界面！当你听完我的这些话后，就可以加入战斗了。战斗分为准备阶段和对战阶段，在准备阶段时，你可以尝试A【物品】、B【防御】、C【魔法】、D【跳过】，不过你现在没有魔法值，没有物品，选择【防御】吧。");this.choose(["防御","跳过"],e=>this.prepare(e))}else{this.round()}}round(){this.log("回合"+(this.rounds+1));switch(this.enemy.id){case 7:if(this.rounds%10===9){this.log("CRD：“什么？！你们居然还能挺得住，看来我要动用增援了！”");this.wait(()=>{this.log("第一个长矛向你袭来");return this.game.battle(8,this)});this.wait(()=>{this.log("第二个长矛向你袭来");return this.game.battle(8,this)})}break;case 8:if(this.rounds===10){this.achieve(2)}}this.rounds++;this.roundEndCallback=[];if(this.enemy.message){let e=1+Math.round(Math.random()*this.enemy.random);if(this.enemy.message[e]){this.log(this.enemy.message[e])}}this.prepareChoose()}prepareChoose(){this.choose(["物品","防御","魔法","跳过"],e=>this.prepare(e))}prepare(e){this.defense=false;this.battleMagic=false;if(this.tutorial){if(e===0){this.defense=true;this.log("星空：很好，让我们试一下战斗吧！");this.log("星空：现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！因为我们点击了防御，我们无法对敌人造成伤害，但攻击可以增加魔法值！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else if(e===1){this.log("星空：你……不选防御吗？那也挺好。");this.log("星空：总之，现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else{throw new Error("Invalid Input.")}}else{switch(e){case 0:let i=false;for(let s in this.game.items){let e=this.game.items[s];let t=d.items[e];if(t.battle===true){i=true;this.game.$items.eq(parseInt(s)).on("click",()=>{this.game.use(this.game.items.indexOf(e),this);this.game.$items.children().off("click")})}}if(!i){this.log("你没有可用的物品。");return this.prepareChoose()}this.log("选择一项物品。");break;case 1:this.log("你选择了防御。");this.defense=true;this.magic+=40;break;case 2:if(this.magic===0||!this.octahedron&&this.magic<this.cureMagicCost){this.log("你的魔法值不够！");return this.prepareChoose()}this.log("你选择了魔法。");this.wait(500);let t=[`治疗魔法（${this.cureMagicCost}）`,"战斗魔法（70）",`黑暗魔法（${this.black?"100":"？"}）`];if(this.octahedron){t.push("几何八面体（消耗全部魔法值造成一半伤害）")}var a=false;const h=()=>this.game.Process(e=>{e.choose(t,s=>{this.game.Process(t=>{switch(s){case 0:if(this.magic<this.cureMagicCost){t.log("你的魔法值不够！");t.wait(500);return}t.log(`你选择了治疗魔法，HP恢复${this.cureMagicPlus}`);this.magic-=this.cureMagicCost;this.game.health+=this.cureMagicPlus;break;case 1:if(this.magic<70){t.log("你的魔法值不够！");t.wait(500);return}t.log(`你选择了战斗魔法，Att提高5，持续一回合。`);this.battleMagic=true;this.magic-=70;this.game.attack+=5;break;case 2:if(this.black){if(this.magic<100){t.log("你的魔法值不够！");return}t.log("水晶被黑暗笼罩住了！黑暗法术增强了！");this.magic=0;this.enemy.health=0}else{t.log("l͓̩̫̘͙͔̯͖̟̤̓͊̑̌́̂̆̚ò̥̪̭̱̰̝̒͂̄͋̿̏͆́̚c͍̲͇͚̖̬͈̪͙̳͌̉́̃k̪̥̱̝̱̑̈́̏̽͗̊̈́͂̀̍e̞͎̩̜̱̩͚̤̊͌̀̀d̠̖̞̝̙̪̟̞̐͛̈̊̀͂̄͌̓̏͌̓ͅ");t.wait(500);return}break;case 3:let e=this.magic;this.magic=0;this.enemy.health-=e/2;t.log(`你选择了几何八面体，对【${this.enemy.name}】造成${e/2}点伤害！`);break;default:throw new Error("非法输入")}t.die(e);a=true}).go();e.die(a?this:h())})}).go();this.wait(()=>h());break;case 3:this.log("你选择了跳过。")}this.wait(()=>{if(this.won){return}const t=()=>{let e=i.val();if(!p.check5Capitals(e)){return}s.remove();this.fight(e)};let s=c("<div/>").appendTo(this.$self);let i=c("<input/>").attr("type","text").appendTo(s).on("keypress",e=>{if(e.which===13)t()});let e=o.button().html("攻击！").appendTo(s).on("click",()=>t())})}}static check5Capitals(t){if(t.length!==5){return false}for(let e=0;e<5;e++){if(!(65<=t.charCodeAt(e)&&t.charCodeAt(e)<=68)){return false}}return true}static computeHurtHarm(a,h,r,n,o,e){if(h<0){h=0}if(r<0){r=0}var l;if(e&&e.enemy.id===4){if(e.special===3){l=Math.floor(Math.random()*4);e.special=0}else{e.special++}}let c=0,d=0,m="";for(let i=0;i<5;i++){let e=a.charCodeAt(i)-65,t=l||Math.floor(Math.random()*4),s=String.fromCharCode(t+65);if(e==t-1||e==3&&t==0){d+=h;p.charWithColor(a.charAt(i),o.$interface,n?0:1,false,i*10+30+"%");p.charWithColor(s,o.$interface,-1,true,i*10+30+"%")}else if(t==e-1||t==3&&e==0){c+=r;p.charWithColor(a.charAt(i),o.$interface,n?0:1,true,i*10+30+"%");p.charWithColor(s,o.$interface,-1,false,i*10+30+"%")}else{p.charWithColor(a.charAt(i),o.$interface,n?0:1,true,i*10+30+"%");p.charWithColor(s,o.$interface,-1,true,i*10+30+"%")}m+=s}return[c,m,d]}static charWithColor(e,t,s,i,a){var h={A:"red",B:"green",C:"brown",D:"aqua"};var r=c("<span/>").html(e).css("color",h[e]).appendTo(t);r.css({fontSize:"3em",position:"fixed",display:"block",left:a,fontWeight:"bold"});if(s===1){r.css("top","70%").animate({top:"50%"},3e3)}else if(s===0){r.css("top","49%").animate({top:"50%"},3e3)}else if(s===-1){r.css("top","20%").animate({top:"40%"},3e3)}if(i){r.fadeOut(1e3,()=>r.remove())}else{if(s===1){r.animate({top:"20%"},3e3,()=>r.remove())}else if(s===0){window.setTimeout(()=>r.remove(),4e3)}else if(s===-1){r.animate({top:"70%"},3e3,()=>r.remove())}}return r}fight(h){if(this.tutorial&&typeof h==="number"){if(h===0){this.magic+=40;this.log("星空：太棒了，现在我们有足够的魔法值来使用魔法了，试一下【魔法】吧，它会给你带来增益效果！剩下的你就自己摸索吧")}else{this.log("星空：呃……你没有听我的，看来你是想自己对战了，那我就不打扰你了！我先给你个治疗法术吧！");this.game.execute("health + 240")}this.tutorial=false}else if(typeof h==="string"){let e=Math.random()<this.enemy.defenseRate;let t=e?this.enemy.defence:0;let[s,i,a]=p.computeHurtHarm(h,this.defense?0:this.game.attack-t,this.enemy.attack-(this.defense?this.game.defence:0),this.defense,this.game);this.log(`你的攻击是${h}，对方的攻击是${i}`);if(e){this.log(`${this.enemy.name}选择了防御。`)}this.log(`你受到${s}点伤害`);this.game.health-=s;this.log(`你造成了${a}点伤害`);this.enemy.health-=a;if(this.withXk){let e=t<20?20-t:0;this.log(`星空造成了${e}点伤害`);this.enemy.health-=e}if(this.battleMagic){this.game.attack-=5}}for(let e of this.roundEndCallback){e.call(this.game)}if(!this.won){this.round()}}get magic(){return this._magic}set magic(e){if(e>100){e=100}this._magic=e;this.$magic.html(e);this.$magicRate.css("height",e+"%")}roundEnd(e){this.roundEndCallback.push(e)}get black(){return this.game.judge(1024)}}class f{constructor(e,t){this.id=e.id;this.battle=t;this.game=t.game;this.name=e.name;this.full=e.health;this.health=e.health;this.attack=e.attack;this.defence=e.defence;this.defenseRate=e.defenseRate;this.random=e.random;this.message=e.message}get health(){return this._health}set health(e){if(e<=0){this.battle.win()}this._health=e;this.battle.$enemyHealth.html(e);this.battle.$enemyHealthRate.css("height",e/this.full*100+"%")}}class o{constructor(){this.$interface=c(".ate-interface");this.$settings=o.button().html("设置").on("click",()=>this.settingsMenu()).appendTo(this.$interface);var e=c("<div/>").addClass("ate-enter").html("Air Ticket Extend<div>Click to start</div>").prependTo(this.$interface).one("click",()=>{e.fadeOut(3e3,()=>{e.remove()})});var t=c("<div/>").addClass("ate-white").prependTo(this.$interface);var s=c("<div/>").addClass("ate-sw0rd").prependTo(this.$interface).hide().fadeIn(1e3);s.on("click",()=>{location.href="https://wiki.cvserver.top"});setTimeout(()=>{t.remove();s.fadeOut(1e3)},4e3);c(document).one("click",()=>document.getElementById("music").play());this.itemImages=[];for(let e of d.items){this.itemImages.push("./images/"+e.id+".png")}this.chooseChapter()}chooseChapter(){var s=c("<div/>").addClass("ate-chapters").appendTo(this.$interface);for(let t=1;t<=5;t++){let e=c("<div/>").addClass("ate-chapter").appendTo(s);if(d[t]){e.html("Chapter "+t).on("click",()=>{this.chapter=t;s.fadeOut(()=>{s.remove();this.run()})})}else{e.addClass("ate-chapter-locked").html("locked")}}}run(){this.$save=o.button().html("保存").on("click",()=>this.save()).appendTo(this.$interface);this.$valsTable=c("<table>").addClass("ate-vals ate-info").appendTo(this.$interface);this.$items=c("<div/>").addClass("ate-items").appendTo(this.$interface);this.$equipments=c("<div/>").addClass("ate-equipments").appendTo(this.$interface);this.$message=c("<div/>").addClass("ate-messages").appendTo(this.$interface);this.$battle=c("<div/>").addClass("ate-battle").appendTo(this.$interface);this.$buttons=c("<div/>").addClass("ate-choices").appendTo(this.$interface);var e=c("<tbody/>").appendTo(this.$valsTable);var t=c("<tr/>").appendTo(e);this.$weapon=c("<div/>").html("武器").appendTo(this.$equipments);this.$armor=c("<div/>").html("防具").appendTo(this.$equipments);c("<td/>").html("HP").appendTo(t);this.$health=c("<span/>").appendTo(c("<td/>").appendTo(t));c("<td/>").html("Att").appendTo(t);this.$attack=c("<span/>").appendTo(c("<td/>").appendTo(t));c("<td/>").html("Def").appendTo(t);this.$defence=c("<span/>").appendTo(c("<td/>").appendTo(t));c("<td/>").html("CM币").appendTo(t);this.$cm=c("<span/>").appendTo(c("<td/>").appendTo(t));this.$healthRate=c("<div/>").addClass("ate-info-rate").css({backgroundColor:"green",health:"100%"}).insertAfter(this.$health);this.max=10;for(let e=0;e<this.max;e++){c("<div/>").addClass("ate-item").appendTo(this.$items)}this.queue=new m(this);this.attack=15;this.defence=0;var s=window.localStorage;if(s.gameData){this.store=JSON.parse(s.gameData);this.health=this.store.health;this.experience=this.store.experience;this.items=this.store.items;for(let e of this.items){this._add(e)}this.weapon=this.store.weapon;this.armor=this.store.armor;this.cm=this.store.cm;this.stackables=this.store.stackables}else{this.store={};this.health=d[this.chapter].maxHealth;this.cm=0;this.experience=[];this.items=[];this.stackables={}}for(let e of d.items){if(e.stackable&&!(e.id in this.stackables)){this.stackables[e.id]=0}}this.R=Math.round(Math.random()*100)+1;this.history=[];this.exp(this.experience.length?this.experience.pop():0)}_log(e){var t=c("<span/>").html(e).css("display","none"),s=c.Deferred();t.css({textAlign:"center"});this.$message.scrollTop(this.$message[0].scrollHeight);this.$message.append(t).append("<br>");t.fadeIn(this.settings.speed,()=>s.resolve());this.history.push(e);return s.promise()}log(e){this.wait(()=>this._log(e))}showItems(){var s=[];c.each(this.items,(e,t)=>s.push(d.items[t].name));return s}putOn(e){if(d.items[e].attack||d.items[e].id===24){this.weapon=e}else if(d.items[e].defence){this.armor=e}else{throw new Error("不可佩戴")}}get attack(){return this._attack}set attack(e){this._attack=e;if(this.weapon===24){this.$attack.html("?");return}this.$attack.html(e)}get defence(){return this._defence}set defence(e){this._defence=e;this.$defence.html(e)}get cm(){return this._cm}set cm(e){this._cm=e;this.$cm.html(e)}get health(){return this._health}set health(e){if(e>d[this.chapter].maxHealth){e=d[this.chapter].maxHealth}else if(e<=0){this.die()}this._health=e;this.$health.html(e);this.$healthRate.css("height",e/240*100+"%")}get weapon(){return this._weapon}set weapon(e){if(!e){return}var t=d.items[e].name,s=this.weapon;this._weapon=e;if(s){if(s===24){window.clearInterval(this.timer.id);this.attack-=this.timer.lastAdd}else{this.attack-=d.items[s].attack}this._add(s);this.items.push(s)}this._removeItem(e);this.items.splice(this.items.indexOf(e),1);this.addImage(this.$weapon,e);if(e===24){this.timer={};this.timer.lastAdd=0;this.timer.id=window.setInterval(()=>{this.attack-=this.timer.lastAdd;this.timer.lastAdd=5+Math.floor(Math.random()*46);this.attack+=this.timer.lastAdd},5e3)}else{this.attack+=d.items[e].attack}this.$weapon.html(t)}get armor(){return this._armor}set armor(e){if(!e){return}var t=d.items[e].name,s=this._armor;this._armor=e;if(s){this.defence-=d.items[s].defence;this._add(s);this.items.push(s)}this._removeItem(e);this.items.splice(this.items.indexOf(e),1);this.addImage(this.$armor,e);this.defence+=d.items[e].defence;this.$armor.html(t)}add(i,a,h){var t=d.items[i];var a=a||1;h=h||this;const e=s=>{if(this.items.length===this.max){var e=this.showItems();e.push("放弃拾取");this.waitProcess(h,t=>{t.log("已满，请丢弃一项");t.choose(e,e=>{if(e===this.max){return t.die(this)}this._remove(e);this.items.splice(e,1);this.items.push(i);if(s){this.setStackableAmount(i,this.stackables[i]+a)}this._add(i);t.die(h)})})}else{this.waitProcess(h,e=>{e.log(`已将${t.name}加入您的背包。`);this.items.push(i);if(s){this.setStackableAmount(i,this.stackables[i]+a)}this._add(i);e.wait(()=>e.die(h))})}};if(t.stackable){if(this.stackables[i]===0){e(true)}else{this.setStackableAmount(i,this.stackables[i]+a)}}else{e(false)}}_add(e){var t=d.items[e];var s=this.$items.children(".ate-item"),i;s.each((e,t)=>{var s=c(t);if(s.html()==""){i=s;return false}});if(!i){throw new Error("没有找到空位")}this.addImage(i,e);i.append(t.name);var a=c("<span/>").addClass("ate-item-description").appendTo(i);var h=c("<div/>").html(t.description).appendTo(a);if(t.stackable){h.append(`<br>你有<span class="ate-item-amount">${this.stackables[e]}</span>个`)}if("attack"in t||"defence"in t||e===24){var r=o.button().html("装备").appendTo(h);r.on("click",()=>{this.putOn(e)})}var n=this.items.length-1;o.button().html("丢弃").appendTo(h).on("click",()=>{if(t.stackable){this.removeItem(e,this.queue.now())}else{this.remove(n,this.queue.now())}})}setStackableAmount(e,t){if(this.stackables[e]!==0&&t!==0){this.$items.eq(this.items.indexOf(e)).find(".ate-item-amount").html(t)}this.stackables[e]=t;if(t===0){this._removeItem(e)}}has(e){return this.items.includes(e)}remove(e,t){var s=this.items[e];t=t||this;t.wait(()=>this._remove(e));return this.items.splice(e,1)[0]}_remove(e){var t=this.$items.children();t.eq(e).html("").css("backgroundImage","").appendTo(this.$items)}removeItem(e){if(d.items[e].stackable){return this.setStackableAmount(e,0)}return this.remove(this.items.indexOf(e))}_removeItem(e){this._remove(this.items.indexOf(e))}use(e,t){var s=this.remove(e);for(let e of d[s].use){this.execute(e,t)}}exp(e){this.$message.html("");this.experience.push(e);var t=d[this.chapter].story[e];if(!Array.isArray(t)){this.story(t)}else{this.story(this.judge(t[1])?t[0]:t[2])}}story(s){for(let t of s.message){let e;if(typeof t==="string"){e=t}else if(Array.isArray(t)){if(t[2]){e=this.judge(t[1])?t[0]:t[2]}else{if(this.judge(t[1])){e=t[0]}else{continue}}}if(e.startsWith("/")){this.execute(e.slice(1))}else if(e.endsWith("/")){this.log(e.slice(0,-1))}else{this.log(e)}}if("battle"in s){this.battle(s.battle,this)}if(s.choice){let t=[];for(let e of s.choice){if(typeof e==="string"){t.push(e)}else if(Array.isArray(e)){if(this.judge(e[1])){t.push(e[0])}else{if(e[2]){t.push(e[2])}}}}this.choose(t,e=>{var t=s.to[e];if(typeof t==="number"){this.exp(t)}else if(Array.isArray(t)){this.exp(this.judge(t[1])?t[0]:t[2])}},s.fadeChoice)}else{let e=s.to;if(!this.settings.pass){this.wait(()=>{var e=c.Deferred();this.$message.append(c("<span/>").html("点按以继续").css("font-size","50%"));this.$message.one("click",()=>e.resolve());return e})}if(typeof e==="number"){this.wait(()=>this.exp(e))}else if(Array.isArray(e)){this.wait(()=>this.exp(this.judge(e[1])?e[0]:e[2]))}}}execute(e,t){var s=e.split(" "),i;switch(s[0]){case"get":this.add(parseInt(s[1]),s[2]&&parseInt(s[2]));break;case"remove":this.remove(this.items.indexOf(parseInt(s[1])));break;case"health":case"cm":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){this[s[0]]+=i}else if(s[1]=="-"){this[s[0]]-=i}break;case"attack":case"defence":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){this[s[0]]+=i;t.roundEnd(()=>{this[s[0]]-=i})}else if(s[1]=="-"){this[s[0]]-=i}break;case"harm":t.enemy.health-=parseInt(s[1]);break;case"dodge":this.dodge(parseInt(s[1]));break;case"bridge":this.bridge();break;case"shop":this.wait(()=>this.shop(parseInt(s[1])));break;case"achieve":this.achieve(s[1]);break;case"sleep":break;default:throw new Error("Unknown Command")}}judge(e){if(typeof e==="number"){return this.experience.includes(e)}else if(typeof e==="string"){let s;if(s=/^([\w\!\&\|]+?)\|([\w\!\&\|]+)$/.exec(e)){return this.judge(s[1])||this.judge(s[2])}if(s=/^([\w\!\&\|]+?)&([\w\!\&\|]+)$/.exec(e)){return this.judge(s[1])&&this.judge(s[2])}if(e.startsWith("!")){return!this.judge(e.slice(1))}if(s=/^([a-z]+)(\d+)$/.exec(e)){let e=s[1];let t=parseInt(s[2]);switch(e){case"r":return this.R===t;case"h":return this.health===t;case"i":return this.has(t);case"a":return this.armor===t;case"w":return this.weapon===t;case"i":return this.items.length===t;case"c":return this.cm>=t;default:throw new Error(`Illegal condition prefix '${e}'.`)}}}}_choose(s,i,a){c(".ate-choices > *").hide();var h=c("<div/>").appendTo(this.$buttons);for(let t in s){let e=c("<div/>").addClass("ate-choice").html(s[t]).appendTo(h);e.on("click",()=>{setTimeout(()=>h.remove());c(".ate-choices > *").show();i.call(s,parseInt(t))});if(a&&a.includes(parseInt(t))){e.css("opacity","0.05")}}h.append(o.clear())}choose(e,t,s){this.wait(()=>this._choose(e,t,s))}wait(t){if(typeof t==="function"){this.queue.push(t,this)}else{this.queue.push(()=>{var e=c.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}save(){if(this.queue.owner!==0){return void this.notify("战斗无法保存")}var e=c.merge([],this.items);if(this.weapon){e.push(this.weapon)}if(this.armor){e.push(this.armor)}var t={health:this.health,items:e,experience:this.experience,weapon:this.weapon,armor:this.armor,cm:this.cm,stackables:this.stackables};localStorage.gameData=JSON.stringify(t);this.notify("保存成功")}battle(t,s){this.wait(()=>{var e=new p(d.battle[t],this,()=>this.queue.give(s));e.run()})}dodge(n){this.waitProcess(this,a=>{const t=()=>{let e=r.val();if(!p.check5Capitals(e)){return}h.remove();let[t,s,i]=p.computeHurtHarm(e,0,n,true,this);a.log(`你的攻击是${e}，对方的攻击是${s}。`);a.log(`你被扣血${t}`);this.health-=t;a.wait(()=>a.die(this))};let h=c("<div/>").appendTo(this.$battle);let r=c("<input/>").attr("type","text").appendTo(h).on("keypress",e=>{if(e.which===13)t()});let e=o.button().html("攻击！").appendTo(h).on("click",()=>t())})}bridge(){this.log("选择一座桥以通过");const a=()=>this.Process(i=>i.choose(["A","B","C"],e=>{var t=Math.floor(Math.random()*3);var s=["A","B","C"];if(e===t){s.splice(t,1);i.log(`翻转地板组成了桥${s.join()}，你没通过桥！`);i.die(a())}else{i.log("你通过了桥！");i.die(this)}})).go();this.wait(()=>a())}shop(e){var n=d.shop[e];const o=()=>this.Process(s=>{var i={},a=[],h=[];for(let t in n){let e=n[t];if(Array.isArray(e)){if(this.judge(e[1])){e=e[0]}else{if(!e[2]){continue}else{e=e[2]}}}i[t]=e;h.push(t);a.push(d.items[t].name+` [cost CM币${e}个]`)}var r=a.length;a.push("离开");s.choose(a,e=>{if(e===r){return s.die(this)}if(this.items.length===this.max){s.log("背包空间不够，你离开了商店");return s.die()}var t=parseInt(h[e]);if(i[t]>this.cm){s.log("你的CM币不够！")}else{this.cm-=i[t];this.add(t,1,s)}s.wait(()=>s.die(o()))})}).go();this.wait(()=>o())}die(){this.log("黑暗再次降临。");if(this.has(2)){this.log("使用复活爱心吗?");this.choose(["是","否"],e=>{if(!e){this.setStackableAmount(2,this.stackables[2]-1);this.health=100;this.log("那么，你将再次驱散黑暗")}else{this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData}})}else{this.log("但是，希望似乎保佑不了你");this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData;delete this.queue}}get settings(){var s;var e={speed:1500,pass:false};function i(){s=localStorage.ateSettings?JSON.parse(localStorage.ateSettings):e}function t(e,t){s[e]=t;localStorage.ateSettings=JSON.stringify(s);i()}i();return{get speed(){return s.speed},set speed(e){t("speed",e)},get pass(){return s.pass},set pass(e){t("pass",e)}}}settingsMenu(){if(c(".ate-settings").length){return}var e=c("<div/>").addClass("ate-settings").appendTo(this.$interface);var t=c("<div/>").addClass("ate-cover").appendTo(this.$interface);var s=c("<ul/>").appendTo(e);var i=c("<input>").attr("type","text").val(this.settings.speed).appendTo(c("<li/>").html("消息播放时间/ms").appendTo(s));var a=o.button().html(this.settings.pass?"是":"否").appendTo(c("<li/>").html("无选项自动跳剧情").appendTo(s));a.on("click",()=>{a.html(this.settings.pass?"否":"是");this.settings.pass=!this.settings.pass});if(this.history){o.button().html("清档").appendTo(e).on("click",()=>{delete localStorage.gameData;this.notify("存档已清除！")});e.append("<div>历史记录：</div>");var h=c("<ol/>").addClass("ate-history").appendTo(e);for(let e of this.history){c("<li/>").html(e).appendTo(h)}}c("<div/>").addClass("ate-settings-done").appendTo(e).on("click",()=>{if(i.val().match(/^\d+$/)){this.settings.speed=parseInt(i.val())}e.animate({left:"-100%"},3e3,()=>e.remove());t.remove()})}static clear(){return c("<div/>").css("clear","both")}addImage(e,t){if(t<this.itemImages.length){e.css("backgroundImage",`url(${this.itemImages[t]})`)}}achieve(e){if(this.achievements.includes(e))return;var t=d.achievement[e];var s=c("<div/>").addClass("ate-achievement");this.$interface.append(s);c("<div/>").addClass("ate-achievement-title").html("成就："+t.name).appendTo(s);c("<span/>").addClass("ate-achievement-content").html(t.description).appendTo(s);s.animate({opacity:1,left:0},2e3);setTimeout(()=>s.fadeOut(3e3),12e3);this.achievements.push(e)}get achievements(){var t=localStorage.ateAchievements?JSON.parse(localStorage.ateAchievements):[];return{push(e){t.push(e);localStorage.ateAchievements=JSON.stringify(t)},includes(e){return t.includes(e)},get length(){return t.length}}}static button(){return c("<div/>").addClass("ate-button")}notify(e){var t=c("<div/>").addClass("ate-notification").appendTo(this.$interface).html(e);t.fadeIn(1500);t.fadeOut(3e3,()=>t.remove())}Process(e){return new t(e,this)}waitProcess(e,t){e.wait(()=>this.Process(t).go())}}var s=new o;document.title="游玩 Air Ticket Extend";c("#firstHeading").html(`--- Air Ticket Extend v ${e} ---`);c("#version").html(e)})(jQuery,ateData,"2.10.0");