"use strict";(function(l,c,e){const t=2;const s=24;function d(e,t){return e+Math.floor(Math.random()*(t-e+1))}class r{constructor(e,t,s,i){this.name=e;this.full=i;this.$title=l("<td/>").html(e).appendTo(t.$tr);this.$valCell=l("<td/>").appendTo(t.$tr);this.$val=l("<span/>").appendTo(this.$valCell);if(s&&i){this.$rate=l("<div/>").addClass("ate-info-rate").insertAfter(this.$val);if(s.startsWith("linear-gradient")){this.$rate.css("backgroundImage",s)}else{this.$rate.css("backgroundColor",s)}}}show(){this.$valCell.fadeIn();this.$title.fadeIn()}hide(){this.$valCell.hide();this.$title.hide()}set(s){if(this.val&&this.val!=s){let e=s-this.val;let t=l("<span/>").html((e>0?"+":"")+e+"");t.appendTo(this.$valCell).addClass("ate-val-rise").css("color",e<0?"red":"green").animate({opacity:0,top:"-3em"},2e3,()=>{t.remove()})}this.val=s;this.$val.html(s+"");if(this.full){this.$rate.css("height",s/this.full*100+"%")}}}class a{constructor(e,t){this.$outer=l("<div/>").addClass(e);var s=l("<table/>").addClass("ate-info").appendTo(this.$outer);var i=l("<tbody/>").appendTo(s);this.$tr=l("<tr/>").appendTo(i);this.$th=l("<th/>").html(t).appendTo(this.$tr);this.health=null;this.magic=null;this.attack=null;this.defence=null;this.cm=null;this.gunHealth=null;this.chaos=null;this.rules=null}add(e,t,s,i,a){var h=new r(t,this,i,s);if(a){h.hide()}this[e]=h;return this}appendTo(e){this.$outer.appendTo(e);return this}remove(){this.$outer.remove();return this}}class h{constructor(e){this.game=e;this.values=localStorage.ateSettings?JSON.parse(localStorage.ateSettings):{speed:1500,pass:false,random:false};this.opened=false;this.hidden=true;this.$element=l(".ate-settings").hide();this.$cover=l("<div/>").addClass("ate-cover").appendTo(this.game.$interface).hide();this.$tags=l(".ate-settings-tag");this.$pages=l(".ate-settings-page");this.index=0;this.$tags.each((e,t)=>{let s=l(t);s.on("click",()=>{if(e===this.index){return}this.$tags.eq(this.index).removeClass("ate-settings-tag-show");this.$pages.eq(this.index).removeClass("ate-settings-page-show");this.index=e;this.$tags.eq(e).addClass("ate-settings-tag-show");this.$pages.eq(e).addClass("ate-settings-page-show")})});for(let s of["pass","random"]){let e=l("#ate-settings-"+s);let t=this.get(s);if(t){e.addClass("ate-button-on")}e.html(t?"是":"否").on("click",()=>{t=!t;this.toggle(s);e.html(t?"是":"否").toggleClass("ate-button-on")})}l("#ate-settings-clear").on("click",()=>{delete localStorage.gameData;this.game.notify("存档已清除！")});if(this.game.history){var t=l(".ate-history");for(let e of this.game.history){l("<li/>").html(e).appendTo(t)}}this.$export=l("#ate-export");this.$doneButton=l(".ate-settings-done");this.$speed=l("#ate-settings-speed").val(this.get("speed"))}get(e){return this.values[e]}set(e,t){this.values[e]=t;localStorage.ateSettings=JSON.stringify(this.values)}toggle(e){this.set(this.get(e))}open(){if(!this.hidden){return}this.opened=true;this.hidden=false;var s=btoa(localStorage.gameData||"");this.$export.val(s);this.$doneButton.one("click",()=>{if(!this.opened){return}this.opened=false;const e=this.$speed.val();if(typeof e!=="string"){throw new Error("$speed.val() is a str")}if(e.match(/^\d+$/)){this.set("speed",parseInt(e))}const t=this.$export.val();if(typeof t!=="string"){throw new Error("$sxport.val() is a str")}if(t!==s){localStorage.gameData=atob(t)}this.$element.animate({left:"-100%"},3e3,()=>{this.$element.hide();this.hidden=true});this.$cover.hide()});this.$cover.show();this.$element.css("left","").show()}}class n{constructor(e){this.arrays={};this.cachedIndexes={};this.processing=false;n.newid(e);this.give(e)}push(e,t){if(t.dead||!this.arrays[t.id]){return}this.arrays[t.id].push(e);if(!this.processing){this.process()}}process(){if(this.processing){return}var t=this.owner;var s=this.arrays[t];var i=this.cachedIndexes[t]||0;this.processing=true;const a=()=>{if(this.processing==false){return}if(t!==this.owner){this.processing=false;this.cachedIndexes[t]=i;return this.process()}if(i>=s.length){this.arrays[t]=[];this.cachedIndexes[t]=0;this.processing=false;return}console.log(s[i],t);let e=s[i++].call(undefined);if(e&&e.done){e.done(a)}else{a()}};a()}give(e){this.owner=e.id;if(!this.arrays[e.id]){this.arrays[e.id]=[]}if(!this.processing){this.process()}}static newid(e){n.registeredOwners.push(e);e.id=n.curid;n.curid++}now(){return n.registeredOwners[this.owner]}}n.registeredOwners=[];n.curid=0;class i{constructor(e,t){if(!t)throw new Error("Missing param game");this.id=-1;n.newid(this);this.func=e;this.dead=false;this.game=t}go(){this.game.queue.give(this);this.func(this)}log(e){this.game.log(e,this)}wait(e){this.game.queue.push(e,this)}choose(e,t){this.wait(()=>this.game._choose(e,t))}die(e){this.dead=true;if(e)this.game.queue.give(e)}waitDie(e){this.wait(()=>this.die(e))}}class o{constructor(e,t,s,i){this.game=t;var a=c.items[e];this.id=e;this.name=a.name;this.description=a.description;this.stackable=a.stackable;this.throwable=a.throwable;if("battle"in a&&a.battle){this.battle=true;this.use=a.use;this.type=o.BATTLE}else if("attack"in a){this.attack=a.attack;this.type=o.WEAPON}else if("defence"in a){this.defence=a.defence;this.type=o.ARMOR}else{this.type=o.NORMAL}this.loadUI(s);if(this.stackable){this.amount=i}}get amount(){return this._amount}set amount(e){this.$amount.html(e+"");this._amount=e}loadUI(e){this.$element=e;e.html("");this.game.addImage(e,this);e.append(l("<span/>").addClass("ate-item-name").html(this.name));var t=l("<span/>").addClass("ate-item-description").appendTo(e);var s=l("<div/>").html(this.description).appendTo(t);console.log("test",e,t);if(this.stackable){this.$amount=l("<span/>");s.append("<br>你有").append(this.$amount).append("个")}if(this.type==o.ARMOR&&this.game.armor!==this||this.type==o.WEAPON&&this.game.weapon!==this){var i=f.button("装备").appendTo(s);i.on("click",()=>{this.game.equip(this)})}if(this.throwable!=false){f.button("丢弃").appendTo(s).on("click",()=>{if(this.game.armor!==this&&this.game.weapon!==this){this.game.removeItem(this)}})}}}o.NORMAL=0;o.BATTLE=1;o.WEAPON=2;o.ARMOR=3;class u{constructor(e,t,s){console.log(this);this.id=-1;n.newid(this);t.queue.give(this);this.game=t;this.tutorial=e.tutorial;this.withXk=e.withXk;this.octahedron=e.octahedron;this.cureMagicCost=this.game.has(14)?50:30;this.cureMagicPlus=this.game.has(14)?80:40;this.$element=t.$battle;this.after=s;this.$element.children().fadeOut();var i=c.enemy[e.enemy];this.won=false;this.afterWin=e.win;this.enemyTable=new a("ate-enemy-table",i.name).appendTo(this.$element);this.enemyTable.add("health","HP",i.health,"red");this.enemyTable.add("gunHealth","炮筒",5,"orange",true);this.enemyTable.add("chaos","混沌",120,"linear-gradient(red, grey)",true);this.enemyTable.add("rules","规则度",100,"linear-gradient(orange, grey)",true);this.enemy=new m(i,this);this.zeroTable=new a("ate-zero-table","Zero").appendTo(this.$element);this.zeroTable.add("magic","魔法值",100,"purple");this.game.$interface.addClass("battling");this.magic=0;this.rounds=0;switch(this.enemy.id){case 14:this.enemyTable.chaos.show();this.chaos=0;this.chaoAttacked=false;break;case 17:this.enemyTable.rules.show();this.rules=0;this.talked=false;this.intenseFight=false;break;default:break}}win(){if(this.won){return}this.won=true;this.log("您获胜了！");if(this.afterWin){for(let e of this.afterWin){this.game.execute(e)}}this.game.$interface.removeClass("battling");setTimeout(()=>{this.enemyTable.remove();this.zeroTable.remove()},2e3);this.$element.children().fadeIn();this.wait(()=>{this.game.queue.give(this.after);this.dead=true})}log(e){this.game.log(e,this)}wait(t){if(typeof t==="function"){this.game.queue.push(t,this)}else{this.game.queue.push(()=>{var e=l.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}choose(e,t){this.wait(()=>this.game._choose(e,t))}run(){if(this.tutorial){this.roundEndCallback=[];this.log("星空说：“让我描述详细一点吧，在魔法系统下，战斗就是我们的【魔法核心】相互接触的过程，每个人都有一个【魔法核心】，只不过大多数人都不会用罢了，我来教你怎么使用。");this.log("星空跟你详细说明了使用魔法核心的方法，你试了一下，突然你感觉世界一下就改变了！");this.log("星空：现在我们进入了战斗界面！当你听完我的这些话后，就可以加入战斗了。战斗分为准备阶段和对战阶段，在准备阶段时，你可以尝试A【物品】、B【防御】、C【魔法】、D【跳过】，不过你现在没有魔法值，没有物品，选择【防御】吧。");this.choose(["防御","跳过"],e=>this.prepare(e))}else{this.round()}}round(){this.log("回合"+(this.rounds+1));this.defense=false;this.battleMagic=false;this.heavyAttack=false;this.fightTimes=1;this.breakHarm=false;this.roundEndCallback=[];if(this.game.armor&&this.game.armor.id===23){this.game.execute("health + [3,20]")}switch(this.enemy.id){case 7:if(this.rounds===9){this.log("CRD：“什么？！你们居然还能挺得住，看来我要动用增援了！”");this.wait(()=>{this.log("第一个短矛向你袭来");return this.game.battle(8,this)});this.wait(()=>{this.log("第二个短矛向你袭来");return this.game.battle(8,this)})}break;case 8:if(this.rounds===6){this.game.achieve(2)}break;case 10:case 11:if(this.rounds%5===4){this.log("鹿法师使用了火魔法！ATT暂时提升5点");this.enemy.attack+=5;this.roundEnd(()=>this.enemy.attack-=5)}break;case 13:if(this.enemy.health<400){this.log("机械木马的HP降低了！");this.log("机械木马使用了【自我修复】！机械木马的HP回升了70点！");if(this.enemy.fixed==false){this.log("“呃……这样真的能击败它吗？”水晶说道。");this.log("“Zero就不能用点什么手段吗……”一个骷髅抱怨道。");this.log("“呃……对了！我看到这个木马的炮管，在平常的时候好像都是掩着的，说不定这就是它的弱点！Zero，它等下发动炮弹攻击的时候，你向炮管打去，看看会怎么样！”水晶说。");this.enemyTable.gunHealth.show();this.enemy.fixed=true}this.enemy.health+=70}if(this.heavyAttack=this.rounds%5===4){this.log("机械木马正在准备一发重型火力攻击。");this.enemy.attack+=20;this.roundEnd(()=>this.enemy.attack-=20)}else if(this.rounds%5===0&&this.rounds>0){this.log("机械木马正在准备一发散弹攻击！");this.fightTimes=2}break;case 17:let e=10;if(this.intenseFight==true){e=5}if(this.defense){e=Math.floor(e/2)}if(d(1,e)==1){this.log("罗尔斯举起了重剑！罗尔斯的攻击力提高了！");this.enemy.attack+=10;this.roundEnd(()=>this.enemy.attack-=10);this.breakHarm=true}if(d(1,e)==1){let e=d(10,35);this.game.health-=e;this.log(`罗尔斯使用了一发扑克散弹,你受到了${e}点伤害！`)}this.enemy.attack+=5;this.roundEnd(()=>this.enemy.attack-=5);default:break}if(this.enemy.message){let e=this.enemy.message;if(typeof e[0]!=="string"){e=this.game.judgeArr(e)}let s=Math.floor(Math.random()*(e.length+1));if(s<e.length){let t=e[s].split(";");for(let e of t){if(e.startsWith("/")){this.game.execute(e.slice(1),this)}else{this.log(e)}}}}this.prepareChoose()}prepareChoose(){this.choose(["物品","防御","魔法","跳过"],e=>this.prepare(e))}prepare(e){if(this.tutorial){if(e===0){this.defense=true;this.log("星空：很好，让我们试一下战斗吧！");this.log("星空：现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！因为我们点击了防御，我们无法对敌人造成伤害，但攻击可以增加魔法值！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else if(e===1){this.log("星空：你……不选防御吗？那也挺好。");this.log("星空：总之，现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else{throw new Error("Invalid Input.")}return}switch(e){case 0:let s=[];for(let t in this.game.items){let e=this.game.items[t];if(e.battle){s.push(parseInt(t))}}if(s.length===0){this.log("你没有可用的物品。");return this.prepareChoose()}this.log("选择一项物品。");this.game.waitProcess(this,t=>{for(let e of s){this.game.$items.children().eq(e).css("boxShadow","2px 2px 4px 4px #66ccff").on("click",()=>{this.game.use(e,this);this.game.$items.children().css("boxShadow","").off("click");t.waitDie(this)})}});if(this.enemy.id===17){this.rules+=d(2,5)}break;case 1:this.log("你选择了防御。");this.defense=true;this.magic+=40;break;case 2:if(this.magic===0||!this.octahedron&&this.magic<this.cureMagicCost){this.log("你的魔法值不够！");return this.prepareChoose()}if(this.enemy.id===17){this.magicChooseForLorce();break}this.magicChoose();break;case 3:this.log("你选择了跳过。")}if(this.enemy.id===14&&!this.defense){if(this.chaoAttacked==false&&(this.chaos>=85||this.enemy.health<=1400)){this.log("混沌持续上升！战斗已经进入白热化！");this.log("现在，你需要独自一人面对考验");this.log("J12132正在释放一次“混沌冲击！”");this.withXk=false;this.octahedron=false;this.chaoAttacked=true;this.fightTimes=2;this.enemy.attack+=5;this.game.virtually(12133);this.roundEnd(()=>{this.enemy.attack-=5})}else{switch(Math.floor(Math.random()*4)){case 0:this.log("小丑使用了“红心治疗”！");this.game.waitChoose(this,["进攻","诅咒"],e=>{if(e==0){this.chaos+=d(3,5);this.enemy.health+=d(10,50)}else{this.log("你诅咒小丑的治疗法术，小丑的法术失效了！");this.chaos+=1}});break;case 1:this.log("小丑使用了“草花守护”！");this.game.waitChoose(this,["进攻","打散"],e=>{if(e==0){this.chaos+=d(3,4);let e=this.game.attack;this.game.attack=0;this.roundEnd(()=>this.game.attack=e)}else{this.log("你用力向草花打去");this.chaos+=2}});break;case 2:this.log("小丑使用了“方块箭矢”！");this.game.waitChoose(this,["进攻","格挡"],e=>{if(e==0){this.chaos+=2;this.game.health-=d(5,35)}else{this.log("你尽可能地格挡箭矢的进攻");this.chaos+=d(1,5);this.game.attack-=10;this.roundEnd(()=>this.game.attack+=10)}});break;case 3:this.log("小丑使用了“黑桃炸弹”！");this.game.waitChoose(this,["进攻","闪躲"],e=>{if(e==0){this.chaos+=d(2,3);this.enemy.attack+=5;this.roundEnd(()=>this.enemy.attack-=5)}else{this.log("你拼命闪躲着炸弹，你的防御增加了！同时攻击减少了");this.chaos+=d(3,5);this.game.defence+=10;this.game.attack-=10;this.roundEnd(()=>this.game.defence-=10);this.roundEnd(()=>this.game.attack+=10)}});break}}}this.fightInput()}magicChoose(){this.log("你选择了魔法。");this.wait(200);let e=[`治疗魔法（${this.cureMagicCost}）`,"战斗魔法（70）",`黑暗魔法（${this.black?"100":"？"}）`];if(this.octahedron){e.push("几何八面体（消耗全部魔法值造成一半伤害）")}this.game.waitChoose(this,e,(t,s,i)=>{switch(t){case 0:if(this.magic<this.cureMagicCost){s.log("你的魔法值不够！");return i()}s.log(`你选择了治疗魔法，HP恢复${this.cureMagicPlus}`);this.magic-=this.cureMagicCost;this.game.health+=this.cureMagicPlus;break;case 1:if(this.magic<70){s.log("你的魔法值不够！");return i()}s.log(`你选择了战斗魔法，Att提高5，持续一回合。`);this.battleMagic=true;this.magic-=70;this.game.attack+=5;break;case 2:if(this.black){if(this.magic<100){s.log("你的魔法值不够！");return i()}s.log("水晶被黑暗笼罩住了！黑暗法术增强了！");this.magic=0;this.enemy.health=0}else{s.log("l͓̩̫̘͙͔̯͖̟̤̓͊̑̌́̂̆̚ò̥̪̭̱̰̝̒͂̄͋̿̏͆́̚c͍̲͇͚̖̬͈̪͙̳͌̉́̃k̪̥̱̝̱̑̈́̏̽͗̊̈́͂̀̍e̞͎̩̜̱̩͚̤̊͌̀̀d̠̖̞̝̙̪̟̞̐͛̈̊̀͂̄͌̓̏͌̓ͅ");return i()}break;case 3:if(this.enemy.id===9){this.game.virtually(200)}let e=this.magic;this.magic=0;this.enemy.health-=e/2;s.log(`你选择了几何八面体，对【${this.enemy.name}】造成${e/2}点伤害！`);break;default:throw new Error("非法输入")}return false})}magicChooseForLorce(){this.log("你选择了魔法。");this.wait(200);if(!this.talked){this.log("星空对你说：“罗尔斯的规则法术……好像对我们也有作用！”");this.talked=true}let e=["超级治疗（60）","规则防御（30）","几何八面体（消耗全部魔法值造成一半伤害）"];this.game.waitChoose(this,e,(t,s,i)=>{switch(t){case 0:if(this.magic<60){this.log("你的魔法值不够！");return i()}this.log("你试着用尽全力使出治疗法术……你的血量和攻击力增加了！");this.game.health+=80;this.game.attack+=5;this.battleMagic=true;this.magic-=60;break;case 1:if(this.magic<30){this.log("你的魔法值不够！");return i()}this.log("你使用了规则防御，罗尔斯的攻击降低了！罗尔斯的防御略微降低了！");this.magic-=30;this.enemy.attack-=10;this.roundEnd(()=>this.enemy.attack+=10);this.enemy.defence-=5;this.roundEnd(()=>this.enemy.defence+=5);break;case 2:let e=this.magic;this.magic=0;this.enemy.health-=e/2;s.log(`你选择了几何八面体，对【罗尔斯】造成${e/2}点伤害！`);break;default:throw new Error("非法输入")}this.rules+=d(3,7);return false})}fightInput(){this.wait(()=>{const t=()=>{let e=i.val();if(!u.check5Capitals(e)){return}s.remove();this.fight(e)};let s=l("<div/>").appendTo(this.zeroTable.$outer);let i=l("<input/>").attr("type","text").appendTo(s).on("keypress",e=>{if(e.which===13){t()}});if(this.game.settings.get("random")){let t=[];for(let e=0;e<5;e++){t.push(65+Math.floor(Math.random()*4))}i.val(String.fromCharCode(...t))}f.button("攻击！").appendTo(s).on("click",()=>t())})}static check5Capitals(t){if(t.length!==5){return false}for(let e=0;e<5;e++){if(!(65<=t.charCodeAt(e)&&t.charCodeAt(e)<=68)){return false}}return true}static computeHurtHarm(a,h,r,n,o,l,c,e){if(h<0){h=0}if(r<0){r=0}var d;if(e&&e.enemy.id===4){if(e.rounds%4===3){d=Math.floor(Math.random()*4)}}let m=0,f=0,g="";for(let i=0;i<5;i++){let e=a.charCodeAt(i)-65,t=d||Math.floor(Math.random()*4),s=String.fromCharCode(t+65);if(e==t-1||e==3&&t==0){f+=h;u.charWithColor(a.charAt(i),l.$interface,n?0:1,false,i*10+30+"%");u.charWithColor(s,l.$interface,-1,true,i*10+30+"%")}else if(t==e-1||t==3&&e==0){let e=false;if(c&&Math.random()<c){o=0;e=true}if(!n){o=0}if(o<r){m+=r-o}console.log(i,e,n);u.charWithColor(a.charAt(i),l.$interface,n?0:1,true,i*10+30+"%",n&&e);u.charWithColor(s,l.$interface,-1,false,i*10+30+"%")}else{u.charWithColor(a.charAt(i),l.$interface,n?0:1,true,i*10+30+"%");u.charWithColor(s,l.$interface,-1,true,i*10+30+"%")}g+=s}return[m,g,f]}static charWithColor(e,t,s,i,a,h){var r={A:"red",B:"green",C:"brown",D:"aqua"};var n=l("<span/>").html(e).css("color",r[e]).appendTo(t);n.css({fontSize:"3em",position:"fixed",display:"block",left:a,fontWeight:"bold"});let o;if(s===1){o="self-"}else if(s===0){o="self-defense-"}else if(s===-1){o="enemy-"}if(h){o+="broken"}else if(i){o+="failed"}else{o+="success"}n.css("animation",`ate-char-${o} 4s linear`);n.css("--char-color",r[e]);window.setTimeout(()=>n.remove(),3800);return n}fight(h){if(this.tutorial&&typeof h==="number"){if(h===0){this.magic+=40;this.log("星空：太棒了，现在我们有足够的魔法值来使用魔法了，试一下【魔法】吧，它会给你带来增益效果！剩下的你就自己摸索吧")}else{this.log("星空：呃……你没有听我的，看来你是想自己对战了，那我就不打扰你了！我先给你个治疗法术吧！");this.game.execute("health + 240")}this.tutorial=false}else if(typeof h==="string"){let e=Math.random()<this.enemy.defenseRate;let t=e?this.enemy.defence:0;let[s,i,a]=u.computeHurtHarm(h,this.defense?0:this.game.attack-t,this.enemy.attack,this.defense,this.game.defence,this.game,this.enemy.id===13&&this.heavyAttack?.3:0,this);this.log(`你的攻击是${h}，对方的攻击是${i}`);if(e){this.log(`${this.enemy.name}选择了防御。`)}this.log(`你受到${s}点伤害`);this.game.health-=s;this.log(`你造成了${a}点伤害`);this.enemy.health-=a;if(this.withXk){let e=t<20?20-t:0;this.log(`星空造成了${e}点伤害`);this.enemy.health-=e}this.fightTimes--;if(this.fightTimes>0){return this.fightInput()}if(this.enemy.fixed&&this.heavyAttack&&a>0){this.log("你朝炮筒攻打过去，机械木马开始松动了");this.enemy.gunHealth--}if(this.battleMagic){this.game.attack-=5}}for(let e of this.roundEndCallback){e.call(this.game)}if(!this.won){this.rounds++;this.round()}}get magic(){return this._magic}set magic(e){if(e>100){e=100}this._magic=e;this.zeroTable.magic.set(e)}get chaos(){return this._chaos}set chaos(e){this._chaos=e;this.enemyTable.chaos.set(e);if(this.chaos>=100){this.log("混沌盘旋着毁灭了战场，你胜利了。");this.game.virtually(12132);this.win()}}get rules(){return this._rules}set rules(e){this._rules=e;this.enemyTable.rules.set(e);if(e>=100){this.log("战斗的规则摇晃着崩塌了");this.win()}}roundEnd(e){this.roundEndCallback.push(e)}get black(){return this.game.judge(1024)&&this.enemy.id===9}}class m{constructor(e,t){this.id=e.id;this.battle=t;this.game=t.game;this.name=e.name;this.full=e.health;this.health=e.health;this.attack=e.attack;this.defence=e.defence;this.defenseRate=e.defenseRate;this.message=e.message;if(this.id===13){this.gunHealth=5;this.fixed=false}}get health(){return this._health}set health(e){this._setHealth(e);if(this.id===13){if(e<=0){this.battle.log("木马的血条似乎空了……但不要以为【自我修复】的力量就这点！");this.game.achieve(3);this._setHealth(this._health+200)}return}else if(this.id===14){if(e<=0){this.battle.win()}}if(e<=0){this.battle.win()}}_setHealth(e){this._health=e;this.battle.enemyTable.health.set(e)}get gunHealth(){return this._gunHealth}set gunHealth(e){if(e<=0){this.battle.log("机械木马剧烈地抖动！你胜利了！");this.battle.win()}this._gunHealth=e;this.battle.enemyTable.gunHealth.set(e)}}class f{constructor(){this.id=-1;this.$interface=l(".ate-interface");this.settings=new h(this);this.$settings=f.button("设置").on("click",()=>this.settings.open()).appendTo(this.$interface);var e=l("<div/>").addClass("ate-enter").html("Extend Air Ticket<div>Click to start</div>").prependTo(this.$interface).one("click",()=>{e.fadeOut(1e3,()=>{e.remove()})});var t=l("<div/>").addClass("ate-white").prependTo(this.$interface);var s=l("<div/>").addClass("ate-sw0rd").prependTo(this.$interface).hide().fadeIn(1e3);var i=l("#author");i.on("click",()=>{i.hide()});setTimeout(()=>{t.remove();s.fadeOut(1e3)},4e3);l(document).one("click",()=>document.getElementById("music").play());this.itemImages=[];for(let e of c.items){this.itemImages.push("./images/"+e.id+".png")}if(localStorage.gameData){this.storage=JSON.parse(localStorage.gameData);this.chapter=this.storage.chapter||1}else{this.chapter=1}this.chooseChapter()}chooseChapter(){var s=l("<div/>").addClass("ate-chapters").appendTo(this.$interface);for(let t=1;t<=5;t++){let e=l("<div/>").addClass("ate-chapter").appendTo(s);if(c[t]&&t==this.chapter){e.html("Chapter "+t).on("click",()=>{s.fadeOut(()=>{s.remove();this.run()})})}else if(c[t]&&t<this.chapter){e.addClass("ate-chapter-passed").html("passed")}else{e.addClass("ate-chapter-locked").html("locked")}}}run(){this.$save=f.button("保存").on("click",()=>this.save()).appendTo(this.$interface);this.table=new a("ate-vals","状态栏").appendTo(this.$interface);this.$items=l("<div/>").addClass("ate-items").appendTo(this.$interface);this.$equipments=l("<div/>").addClass("ate-equipments").appendTo(this.$interface);this.$message=l("<div/>").addClass("ate-messages").appendTo(this.$interface);this.$battle=l("<div/>").addClass("ate-battle").appendTo(this.$interface);this.$buttons=l("<div/>").addClass("ate-choices").appendTo(this.$interface);this.$weapon=l("<div/>").addClass("ate-item").appendTo(this.$equipments);this.$armor=l("<div/>").addClass("ate-item").appendTo(this.$equipments);this.$weapon.append(l("<span/>").addClass("ate-item-name").html("武器"));this.$armor.append(l("<span/>").addClass("ate-item-name").html("防具"));this.table.add("health","HP",c[this.chapter].maxHealth,"green");this.table.add("attack","Att");this.table.add("defence","Def");this.table.add("cm","CM币");this.max=c[this.chapter].maxItems;for(let e=0;e<this.max;e++){l("<div/>").addClass("ate-item").appendTo(this.$items)}this.queue=new n(this);this.dead=false;this.attack=15;this.defence=0;var e=window.localStorage;if(e.gameData){this.storage=JSON.parse(e.gameData);this.health=this.storage.health;this.items=[];this.experience=this.storage.experience;this.stackables=this.storage.stackables;var t=this.storage.items;if(this.storage.weapon){this.weapon=new o(this.storage.weapon,this,this.$weapon,1);t.splice(t.indexOf(this.storage.weapon),1)}if(this.storage.armor){this.armor=new o(this.storage.armor,this,this.$armor,1);t.splice(t.indexOf(this.storage.armor),1)}for(let e of t){this.add(e,this.stackables[e])}this.cm=this.storage.cm;this.virtualExperience=this.storage.virtual||[]}else{this.storage={};this.health=c[this.chapter].maxHealth;this.cm=0;this.experience=[];this.stackables={};this.items=[];this.virtualExperience=[]}this.R=Math.round(Math.random()*100)+1;this.history=[];this.exp(this.experience.length?this.experience.pop():0)}log(s,e=this){e.wait(()=>{var e=l("<span/>").html(s).css("display","none");var t=l.Deferred();this.$message.scrollTop(this.$message[0].scrollHeight);this.$message.append(e).append("<br>");if(this.settings.get("speed")===0){e.show();this.$message.one("click",()=>t.resolve())}else{e.fadeIn(this.settings.get("speed"),()=>t.resolve())}this.history.push(s);return t})}showItems(t){var s=[];for(let e of this.items){if(e.throwable!==false||!t){s.push(e.name)}}return s}equip(e){this.items.splice(this.items.indexOf(e),1);if(e.type===o.WEAPON){this.weapon=e}else if(e.type===o.ARMOR){this.armor=e}else{throw new Error("不可佩戴")}}get attack(){return this._attack}set attack(e){this._attack=e;if(this.weapon&&this.weapon.id===s){this.table.attack.$val.html("?");return}this.table.attack.set(e)}get defence(){return this._defence}set defence(e){this._defence=e;this.table.defence.set(e)}get cm(){return this._cm}set cm(e){this._cm=e;this.table.cm.set(e)}get health(){return this._health}set health(e){if(e>c[this.chapter].maxHealth){e=c[this.chapter].maxHealth}else if(e<=0){this.die()}this._health=e;this.table.health.set(e)}get weapon(){return this._weapon}set weapon(e){if(!e||e===this.weapon){return}var t=this.weapon;this._weapon=e;if(t){if(t.id===s){window.clearInterval(this.timer.id);this.attack-=this.timer.lastAdd}else{this.attack-=t.attack}t.$element.insertBefore(this.findBlankItem());this.items.push(t)}else if(e.$element!==this.$weapon){this.$weapon.html("").appendTo(this.$items)}e.$element.prependTo(this.$equipments);if(e.id===s){this.timer={};this.timer.lastAdd=0;this.timer.id=window.setInterval(()=>{this.attack-=this.timer.lastAdd;this.timer.lastAdd=d(5,50);this.attack+=this.timer.lastAdd},5e3)}else{this.attack+=e.attack}}get armor(){return this._armor}set armor(e){if(!e||e===this.armor){return}var t=this._armor;this._armor=e;if(t){this.defence-=t.defence;t.$element.insertBefore(this.findBlankItem());this.items.push(t)}else if(e.$element!==this.$armor){this.$armor.html("").appendTo(this.$items)}e.$element.appendTo(this.$equipments);this.defence+=e.defence}findItem(t){if(t===undefined){return undefined}for(let e of this.items){if(e.id===t){return e}}}waitGet(s,i,a){var i=i||1;a=a||this;const e=()=>{if(this.itemsFull(s)){this.wait(()=>{var e=this.showItems(true);e.push("放弃拾取");this.Process(t=>{t.log("已满，请丢弃一项");t.choose(e,e=>{if(e===this.max){return t.die(this)}this.remove(e);this.add(s,i);t.die(a)})}).go()})}else{var t=this.add(s,i);this.waitProcess(a,e=>{e.log(`已将${t.name}加入您的背包。`);e.waitDie(a)})}};var t=this.findItem(s);if(t&&t.stackable){t.amount+=i}else{e()}}findBlankItem(){var e=this.$items.children(".ate-item");var i;e.each((e,t)=>{var s=l(t);if(s.html()==""){i=s;return false}});if(!i){throw new Error("没有找到空位")}return i}itemsFull(e){var t;if(e!==undefined){t=c.items[e].stackable}return this.items.length===this.max&&!(t&&this.has(e))}add(e,t){var s=new o(e,this,this.findBlankItem(),t);this.items.push(s);return s}has(e){return!!this.findItem(e)}remove(e){var t=this.items.splice(e,1)[0];t.$element.html("").css("backgroundImage","").appendTo(this.$items);return t}waitRemove(e,t){t=t||this;t.wait(()=>void this.remove(e))}removeItem(e){return this.remove(this.items.indexOf(e))}waitRemoveItem(e,t){t=t||this;t.wait(()=>void this.removeItem(e))}use(e,t){var s=this.items[e];this.waitRemove(e,t);t.log(s.name);for(let e of s.use){this.execute(e,t)}}exp(e){this.cache();this.$message.html("");this.experience.push(e);const t=c[this.chapter].story[e];if(Array.isArray(t)){this.story(this.judgeArr(t))}else{this.story(t)}}story(h){for(let t of h.message){let e;if(typeof t==="string"){e=t}else if(Array.isArray(t)){e=this.judgeArr(t);if(!e){continue}}if(e.startsWith("/")){this.execute(e.slice(1))}else if(e.endsWith("/")){this.log(e.slice(0,-1))}else{this.log(e)}}if("battle"in h){this.battle(h.battle,this)}if("choice"in h){if("to"in h){let t=h.choice.length;let i=[];let a=[];for(let e=0;e<t;e++){let t=h.choice[e];let s=h.to[e];if(typeof t==="string"){i.push(t);a.push(s)}else if(Array.isArray(t)){let e=this.judgeArr(t);if(e){i.push(e);a.push(s)}}}this.choose(i,e=>{const t=a[e];if(typeof t==="number"){this.exp(t)}else if(Array.isArray(t)){this.exp(this.judgeArr(t))}},h.fadeChoice)}else{this.wait(()=>{let i=l("<input/>").attr("type","text").appendTo(this.$message).on("keypress",e=>{if(e.which===13){const t=i.val();if(!("#default"in h.choice)){if(t in h.choice){const s=h.choice[t];if(typeof s==="number"){this.exp(s)}else if(Array.isArray(s)){this.exp(this.judgeArr(s))}}else{return}}else{const s=h.choice[t in h.choice?t:"#default"];if(typeof s==="number"){this.exp(s)}else if(Array.isArray(s)){this.exp(this.judgeArr(s))}}i.remove()}})})}}else{const e=h.to;if(!this.settings.get("pass")){this.wait(()=>{var e=l.Deferred();this.$message.append(l("<span/>").html("点按以继续").css("font-size","50%"));this.$message.one("click",()=>e.resolve());return e})}if(typeof e==="number"){this.wait(()=>this.exp(e))}else if(Array.isArray(e)){this.wait(()=>this.exp(this.judgeArr(e)))}else if(e===true){this.experience=[];this.chapter++;this.health=c[this.chapter].maxHealth;this.cache();this.save();this.log("请重启游戏！");this.wait(()=>location.reload())}else{this.log("敬请期待！")}}}execute(e,t){var s=e.split(" "),i;switch(s[0]){case"get":this.waitGet(parseInt(s[1]),s[2]&&parseInt(s[2]));break;case"remove":this.removeItem(this.findItem(parseInt(s[1])));break;case"health":case"cm":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){this[s[0]]+=i}else if(s[1]=="-"){this[s[0]]-=i}break;case"attack":case"defence":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(t){if(s[1]=="+"){this[s[0]]+=i;t.roundEnd(()=>{this[s[0]]-=i})}else if(s[1]=="-"){this[s[0]]-=i;t.roundEnd(()=>{this[s[0]]+=i})}}else{if(s[1]=="+"){this[s[0]]+=i}else if(s[1]=="-"){this[s[0]]-=i}}break;case"harm":t.enemy.health-=parseInt(s[1]);break;case"dodge":this.dodge(parseInt(s[1]),s[2]);break;case"bridge":this.bridge();break;case"floor":this.floor();break;case"shop":this.wait(()=>this.shop(parseInt(s[1])));break;case"achieve":this.achieve(parseInt(s[1]));break;case"edefence":case"eattack":let e=s[0].slice(1);if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){t.enemy[e]+=i;t.roundEnd(()=>{t.enemy[e]-=i})}else if(s[1]=="-"){t.enemy[e]-=i;t.roundEnd(()=>{t.enemy[e]+=i})}break;case"experience":this.virtually(parseInt(s[1]));break;case"sleep":break;default:throw new Error("Unknown Command")}}judge(t){if(typeof t==="number"){return this.experience.includes(t)}else if(typeof t==="string"){if(/^[0-9]+$/.test(t)){return this.experience.includes(parseInt(t))}let e;if(e=/^([\w\!\&\|]+?)\|([\w\!\&\|]+)$/.exec(t)){return this.judge(e[1])||this.judge(e[2])}if(e=/^([\w\!\&\|]+?)&([\w\!\&\|]+)$/.exec(t)){return this.judge(e[1])&&this.judge(e[2])}if(t.startsWith("!")){return!this.judge(t.slice(1))}if(e=/^([a-z]+)(\d+)$/.exec(t)){let s=e[1];let i=parseInt(e[2]);switch(s){case"r":return this.R===i;case"health":case"h":return this.health===i;case"item":case"i":return this.has(i);case"armor":case"a":let e=this.armor;return e!==undefined&&e.id===i;case"weapon":case"w":let t=this.weapon;return t!==undefined&&t.id===i;case"cm":case"c":return this.cm>=i;case"virtual":case"v":return this.virtualExperience.includes(i);case"attack":case"att":return this.attack>=i;case"defence":case"def":return this.defence>=i;default:throw new Error(`Illegal condition prefix '${s}'.`)}}}}static isValidCondition(e){return typeof e==="number"||/^[a-z0-9&\|!]+$/.test(e)}judgeArr(t){var s=t.length;if(!f.isValidCondition(t[1])){return t[d(0,s-1)]}var i;for(let e=0;e<s;e++){if(e===s-1){i=t[e];break}if(this.judge(t[e+1])){i=t[e];break}e++}return i}_choose(s,i,a){l(".ate-choices > *").hide();var h=l("<div/>").appendTo(this.$buttons);for(let t in s){let e=l("<div/>").addClass("ate-choice").html(s[t]).appendTo(h);e.on("click",()=>{setTimeout(()=>h.remove());l(".ate-choices > *").show();i.call(s,parseInt(t))});if(a&&a.includes(parseInt(t))){e.css("opacity","0.05")}}h.append(f.clear())}choose(e,t,s){this.wait(()=>this._choose(e,t,s))}wait(t){if(typeof t==="function"){this.queue.push(t,this)}else{this.queue.push(()=>{var e=l.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}cache(){var t=[];var s={};for(let e of this.items){t.push(e.id);if(e.stackable){s[e.id]=e.amount}}if(this.weapon){t.push(this.weapon.id)}if(this.armor){t.push(this.armor.id)}this.storage={health:this.health,items:t,experience:this.experience,weapon:this.weapon?this.weapon.id:null,armor:this.armor?this.armor.id:null,cm:this.cm,stackables:s,virtual:this.virtualExperience,chapter:this.chapter}}save(){localStorage.gameData=JSON.stringify(this.storage);this.notify("保存成功")}battle(t,s){s.wait(()=>{var e=new u(c.battle[t],this,s);e.run()})}dodge(n,o){this.waitProcess(this,a=>{this.$interface.addClass("battling");const t=()=>{let e=r.val();if(typeof e!=="string"){throw new Error("Str should be string")}if(!u.check5Capitals(e)){return}h.remove();let[t,s,i]=u.computeHurtHarm(e,0,n,true,0,this);a.log(`你的攻击是${e}，${o}的攻击是${s}。`);a.log(`你被扣血${t}`);this.health-=t;a.wait(()=>void this.$interface.removeClass("battling"));a.wait(()=>a.die(this))};let h=l("<div/>").appendTo(this.$battle);let r=l("<input/>").attr("type","text").appendTo(h).on("keypress",e=>{if(e.which===13)t()});if(this.settings.get("random")){let t=[];for(let e=0;e<5;e++){t.push(d(65,68))}r.val(String.fromCharCode(...t))}let e=f.button("攻击！").appendTo(h).on("click",()=>t())})}bridge(e=false){var t=e?4:3;var h=e?"地板":"桥";this.log(`选择一${e?"条路线":"座桥"}以通过`);var r=[];for(let e=0;e<t;e++){r.push(String.fromCharCode(65+e))}this.waitChoose(this,r,(e,t,s)=>{var i=Math.floor(Math.random()*3);var a=Array.from(r);if(e===i){a.splice(i,1);t.log(`翻转地板组成了${h+a.join()}，你没通过${h}！`);return s()}else{t.log(`你通过了${h}！`)}})}floor(){return this.bridge(true)}shop(e){var n=c.shop[e];const o=()=>this.Process(s=>{var i={},a=[],h=[];for(let t in n){let e=n[t];if(Array.isArray(e)){e=this.judgeArr(e);if(!e){continue}}i[t]=e;h.push(t);a.push(c.items[t].name+` [cost CM币${e}个]`)}var r=a.length;a.push("离开");s.choose(a,e=>{if(e===r){return s.die(this)}var t=parseInt(h[e]);if(this.itemsFull(t)){s.log("背包空间不够，你离开了商店");return s.waitDie(this)}if(i[t]>this.cm){s.log("你的CM币不够！")}else{this.cm-=i[t];this.waitGet(t,1,s)}s.wait(()=>s.die(o()))})}).go();this.wait(()=>o())}virtually(e){this.virtualExperience.push(e)}die(){this.log("黑暗再次降临。");if(this.has(t)){this.log("使用复活爱心吗?");this.choose(["是","否"],e=>{if(!e){this.findItem(t).amount--;this.health=100;this.log("那么，你将再次驱散黑暗")}else{this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData;delete this.queue}})}else{this.log("但是，希望似乎保佑不了你");this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData;delete this.queue}}static clear(){return l("<div/>").css("clear","both")}addImage(e,t){if(t instanceof o){t=t.id}if(t<this.itemImages.length){e.css("backgroundImage",`url(${this.itemImages[t]})`)}}achieve(e){if(this.achievements.includes(e)){return}var t=c.achievement[e];var s=l("<div/>").addClass("ate-achievement");this.$interface.append(s);l("<div/>").addClass("ate-achievement-title").html("成就："+t.name).appendTo(s);l("<span/>").addClass("ate-achievement-content").html(t.description).appendTo(s);s.animate({opacity:1,left:0},2e3);setTimeout(()=>s.fadeOut(3e3),12e3);this.achievements.push(e)}get achievements(){var t=localStorage.ateAchievements?JSON.parse(localStorage.ateAchievements):[];return{push(e){t.push(e);localStorage.ateAchievements=JSON.stringify(t)},includes(e){return t.includes(e)},get length(){return t.length}}}static button(e,t){var s=l("<div/>").addClass("ate-button").html(e);if(t){if(t.cls){s.addClass("ate-button-"+t.cls)}if(t.title){s.attr("title",t.title)}}return s}notify(e){var t=l("<div/>").addClass("ate-notification").appendTo(this.$interface).html(e);t.fadeIn(1500);t.fadeOut(3e3,()=>t.remove())}Process(e){return new i(e,this)}waitProcess(e,t){e.wait(()=>this.Process(t).go())}waitChoose(a,e,h){this.waitProcess(a,s=>{const i=()=>{s.choose(e,e=>{let t=h(e,s,i);if(t!==true){s.die(a)}});return true};i()})}}var g=new f;document.title="游玩 Extend Air Ticket";l("#firstHeading").html(`--- Extend Air Ticket v ${e} ---`);l("#version").html(e)})(jQuery,ateData,"2.13.0.1");