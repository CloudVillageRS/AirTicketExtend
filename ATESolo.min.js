"use strict";(function(d,l,e){function a(e,t){return e+Math.floor(Math.random()*(t-e+1))}class r{constructor(e,t,s,i){this.name=e;this.full=i;this.$title=d("<td/>").html(e).appendTo(t.$tr);this.$valCell=d("<td/>").appendTo(t.$tr);this.$val=d("<span/>").appendTo(this.$valCell);if(s&&i){this.$rate=d("<div/>").addClass("ate-info-rate").css("backgroundColor",s).insertAfter(this.$val)}}show(){this.$valCell.fadeIn();this.$title.fadeIn()}hide(){this.$valCell.hide();this.$title.hide()}set(s){if(this.val&&this.val!=s){let e=s-this.val;let t=d("<span/>").html((e>0?"+":"")+e+"");t.appendTo(this.$valCell).addClass("ate-val-rise").css("color",e<0?"red":"green").animate({opacity:0,top:"-3em"},2e3,()=>{t.remove()})}this.val=s;this.$val.html(s+"");if(this.full){this.$rate.css("height",s/this.full*100+"%")}}}class h{constructor(e,t){this.$outer=d("<div/>").addClass(e);var s=d("<table/>").addClass("ate-info").appendTo(this.$outer);var i=d("<tbody/>").appendTo(s);this.$tr=d("<tr/>").appendTo(i);this.$th=d("<th/>").html(t).appendTo(this.$tr);this.health=null;this.magic=null;this.attack=null;this.defence=null;this.cm=null;this.gunHealth=null;this.chaos=null;this.rules=null}add(e,t,s,i,a){var h=new r(t,this,i,s);if(a){h.hide()}this[e]=h;return this}appendTo(e){this.$outer.appendTo(e);return this}remove(){this.$outer.remove();return this}}class n{constructor(e){this.arrays={};this.cachedIndexes={};this.processing=false;n.newid(e);this.give(e)}push(e,t){if(t.dead||!this.arrays[t.id]){return}this.arrays[t.id].push(e);if(!this.processing){this.process()}}process(){if(this.processing){return}var t=this.owner;var s=this.arrays[t];var i=this.cachedIndexes[t]||0;this.processing=true;const a=()=>{if(this.processing==false){return}if(t!==this.owner){this.processing=false;this.cachedIndexes[t]=i;return this.process()}if(i>=s.length){this.arrays[t]=[];this.cachedIndexes[t]=0;this.processing=false;return}console.log(s[i],t);let e=s[i++].call(undefined);if(e&&e.done){e.done(a)}else{a()}};a()}give(e){this.owner=e.id;if(!this.arrays[e.id]){this.arrays[e.id]=[]}if(!this.processing){this.process()}}static newid(e){n.registeredOwners.push(e);e.id=n.curid;n.curid++}now(){return n.registeredOwners[this.owner]}}n.registeredOwners=[];n.curid=0;class t{constructor(e,t){if(!t)throw new Error("Missing param game");this.id=-1;n.newid(this);this.func=e;this.dead=false;this.game=t}go(){this.game.queue.give(this);this.func(this)}log(e){this.wait(()=>this.game._log(e))}wait(e){this.game.queue.push(e,this)}choose(e,t){this.wait(()=>this.game._choose(e,t))}die(e){this.dead=true;if(e)this.game.queue.give(e)}waitDie(e){this.wait(()=>this.die(e))}}class p{constructor(e,t,s){console.log(this);this.id=-1;n.newid(this);t.queue.give(this);this.game=t;this.tutorial=e.tutorial;this.withXk=e.withXk;this.octahedron=e.octahedron;this.cureMagicCost=this.game.has(14)?50:30;this.cureMagicPlus=this.game.has(14)?80:40;this.$element=t.$battle;this.after=s;this.$element.children().fadeOut();var i=l.enemy[e.enemy];this.won=false;this.afterWin=e.win;this.enemyTable=new h("ate-enemy-table",i.name).appendTo(this.$element);this.enemyTable.add("health","HP",i.health,"red");this.enemyTable.add("gunHealth","炮筒",5,"orange",true);this.enemyTable.add("chaos","混沌",120,"linear-gradient(red, grey)",true);this.enemy=new o(i,this);this.zeroTable=new h("ate-zero-table","Zero").appendTo(this.$element);this.zeroTable.add("magic","魔法值",100,"purple");this.game.$interface.addClass("battling");this.magic=0;this.rounds=0;if(this.enemy.id===14){this.enemyTable.chaos.show();this.chaos=0;this.chaoAttacked=false}}win(){if(this.won){return}this.won=true;this.log("您获胜了！");if(this.afterWin){for(let e of this.afterWin){this.game.execute(e)}}this.game.$interface.removeClass("battling");setTimeout(()=>{this.enemyTable.remove();this.zeroTable.remove()},2e3);this.$element.children().fadeIn();this.wait(()=>{this.game.queue.give(this.after);this.dead=true})}log(e){this.wait(()=>this.game._log(e))}wait(t){if(typeof t==="function"){this.game.queue.push(t,this)}else{this.game.queue.push(()=>{var e=d.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}choose(e,t){this.wait(()=>this.game._choose(e,t))}run(){if(this.tutorial){this.roundEndCallback=[];this.log("星空说：“让我描述详细一点吧，在魔法系统下，战斗就是我们的【魔法核心】相互接触的过程，每个人都有一个【魔法核心】，只不过大多数人都不会用罢了，我来教你怎么使用。");this.log("星空跟你详细说明了使用魔法核心的方法，你试了一下，突然你感觉世界一下就改变了！");this.log("星空：现在我们进入了战斗界面！当你听完我的这些话后，就可以加入战斗了。战斗分为准备阶段和对战阶段，在准备阶段时，你可以尝试A【物品】、B【防御】、C【魔法】、D【跳过】，不过你现在没有魔法值，没有物品，选择【防御】吧。");this.choose(["防御","跳过"],e=>this.prepare(e))}else{this.round()}}round(){this.log("回合"+(this.rounds+1));this.defense=false;this.battleMagic=false;this.heavyAttack=false;this.fightTimes=1;this.roundEndCallback=[];if(this.game.armor===23){this.game.execute("health + [3,20]")}switch(this.enemy.id){case 7:if(this.rounds===9){this.log("CRD：“什么？！你们居然还能挺得住，看来我要动用增援了！”");this.wait(()=>{this.log("第一个短矛向你袭来");return this.game.battle(8,this)});this.wait(()=>{this.log("第二个短矛向你袭来");return this.game.battle(8,this)})}break;case 8:if(this.rounds===6){this.game.achieve(2)}break;case 10:case 11:if(this.rounds%5===4){this.log("鹿法师使用了火魔法！ATT暂时提升5点");this.enemy.attack+=5;this.roundEnd(()=>this.enemy.attack-=5)}break;case 13:if(this.enemy.health<400){this.log("机械木马的HP降低了！");this.log("机械木马使用了【自我修复】！机械木马的HP回升了70点！");if(this.enemy.fixed==false){this.log("“呃……这样真的能击败它吗？”水晶说道。");this.log("“Zero就不能用点什么手段吗……”一个骷髅抱怨道。");this.log("“呃……对了！我看到这个木马的炮管，在平常的时候好像都是掩着的，说不定这就是它的弱点！Zero，它等下发动炮弹攻击的时候，你向炮管打去，看看会怎么样！”水晶说。");this.enemyTable.gunHealth.show();this.enemy.fixed=true}this.enemy.health+=70}if(this.heavyAttack=this.rounds%5===4){this.log("机械木马正在准备一发重型火力攻击。");this.enemy.attack+=20;this.roundEnd(()=>this.enemy.attack-=20)}else if(this.rounds%5===0&&this.rounds>0){this.log("机械木马正在准备一发散弹攻击！");this.fightTimes=2}break;default:break}if(this.enemy.message){let e=this.enemy.message;if(typeof e[0]!=="string"){e=this.game.judgeArr(e)}let s=Math.floor(Math.random()*(e.length+1));if(s<e.length){let t=e[s].split(";");for(let e of t){if(e.startsWith("/")){this.game.execute(e.slice(1),this)}else{this.log(e)}}}}this.prepareChoose()}prepareChoose(){this.choose(["物品","防御","魔法","跳过"],e=>this.prepare(e))}prepare(e){if(this.tutorial){if(e===0){this.defense=true;this.log("星空：很好，让我们试一下战斗吧！");this.log("星空：现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！因为我们点击了防御，我们无法对敌人造成伤害，但攻击可以增加魔法值！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else if(e===1){this.log("星空：你……不选防御吗？那也挺好。");this.log("星空：总之，现在是进入【战斗】的时间了！");this.log("敌人会利用A、B、C、D四种方式攻击你，每回合攻击五次，其中，D克A克B克C克D，这个木马接下来会使用AAAAA攻击，回复DDDDD来阻止它吧！");this.choose(["DDDDD","你在教我做事？"],e=>this.fight(e))}else{throw new Error("Invalid Input.")}return}switch(e){case 0:let i=[];for(let s in this.game.items){let e=this.game.items[s];let t=l.items[e];if("battle"in t&&t.battle===true){i.push(parseInt(s))}}if(i.length===0){this.log("你没有可用的物品。");return this.prepareChoose()}this.log("选择一项物品。");this.game.waitProcess(this,t=>{for(let e of i){this.game.$items.children().eq(e).css("boxShadow","2px 2px 4px 4px #66ccff").on("click",()=>{this.game.use(e,this);this.game.$items.children().css("boxShadow","").off("click");t.waitDie(this)})}});break;case 1:this.log("你选择了防御。");this.defense=true;this.magic+=40;break;case 2:if(this.magic===0||!this.octahedron&&this.magic<this.cureMagicCost){this.log("你的魔法值不够！");return this.prepareChoose()}this.magicChoose();break;case 3:this.log("你选择了跳过。")}this.fightInput()}fightInput(){this.wait(()=>{const t=()=>{let e=i.val();if(!p.check5Capitals(e)){return}s.remove();this.fight(e)};let s=d("<div/>").appendTo(this.zeroTable.$outer);let i=d("<input/>").attr("type","text").appendTo(s).on("keypress",e=>{if(e.which===13){t()}});if(this.game.settings.get("random")){let t=[];for(let e=0;e<5;e++){t.push(65+Math.floor(Math.random()*4))}i.val(String.fromCharCode(...t))}m.button().html("攻击！").appendTo(s).on("click",()=>t())})}magicChoose(){this.log("你选择了魔法。");this.wait(500);let t=[`治疗魔法（${this.cureMagicCost}）`,"战斗魔法（70）",`黑暗魔法（${this.black?"100":"？"}）`];if(this.octahedron){t.push("几何八面体（消耗全部魔法值造成一半伤害）")}var i=false;const a=()=>this.game.Process(e=>{e.choose(t,s=>{this.game.Process(t=>{switch(s){case 0:if(this.magic<this.cureMagicCost){t.log("你的魔法值不够！");return}t.log(`你选择了治疗魔法，HP恢复${this.cureMagicPlus}`);this.magic-=this.cureMagicCost;this.game.health+=this.cureMagicPlus;break;case 1:if(this.magic<70){t.log("你的魔法值不够！");return}t.log(`你选择了战斗魔法，Att提高5，持续一回合。`);this.battleMagic=true;this.magic-=70;this.game.attack+=5;break;case 2:if(this.black){if(this.magic<100){t.log("你的魔法值不够！");return}t.log("水晶被黑暗笼罩住了！黑暗法术增强了！");this.magic=0;this.enemy.health=0}else{t.log("l͓̩̫̘͙͔̯͖̟̤̓͊̑̌́̂̆̚ò̥̪̭̱̰̝̒͂̄͋̿̏͆́̚c͍̲͇͚̖̬͈̪͙̳͌̉́̃k̪̥̱̝̱̑̈́̏̽͗̊̈́͂̀̍e̞͎̩̜̱̩͚̤̊͌̀̀d̠̖̞̝̙̪̟̞̐͛̈̊̀͂̄͌̓̏͌̓ͅ");return}break;case 3:if(this.enemy.id===9){this.game.virtually(200)}let e=this.magic;this.magic=0;this.enemy.health-=e/2;t.log(`你选择了几何八面体，对【${this.enemy.name}】造成${e/2}点伤害！`);break;default:throw new Error("非法输入")}t.die(e);i=true}).go();e.die(i?this:a())})}).go();this.wait(()=>a())}static check5Capitals(t){if(t.length!==5){return false}for(let e=0;e<5;e++){if(!(65<=t.charCodeAt(e)&&t.charCodeAt(e)<=68)){return false}}return true}static computeHurtHarm(a,h,r,n,o,l,c,e){if(h<0){h=0}if(r<0){r=0}var d;if(e&&e.enemy.id===4){if(e.rounds%4===3){d=Math.floor(Math.random()*4)}}let m=0,f=0,u="";for(let i=0;i<5;i++){let e=a.charCodeAt(i)-65,t=d||Math.floor(Math.random()*4),s=String.fromCharCode(t+65);if(e==t-1||e==3&&t==0){f+=h;p.charWithColor(a.charAt(i),l.$interface,n?0:1,false,i*10+30+"%");p.charWithColor(s,l.$interface,-1,true,i*10+30+"%")}else if(t==e-1||t==3&&e==0){let e=false;if(c&&Math.random()<c){o=0;e=true}if(o<r){m+=r-o}console.log(i,e,n);p.charWithColor(a.charAt(i),l.$interface,n?0:1,true,i*10+30+"%",n&&e);p.charWithColor(s,l.$interface,-1,false,i*10+30+"%")}else{p.charWithColor(a.charAt(i),l.$interface,n?0:1,true,i*10+30+"%");p.charWithColor(s,l.$interface,-1,true,i*10+30+"%")}u+=s}return[m,u,f]}static charWithColor(e,t,s,i,a,h){var r={A:"red",B:"green",C:"brown",D:"aqua"};var n=d("<span/>").html(e).css("color",r[e]).appendTo(t);n.css({fontSize:"3em",position:"fixed",display:"block",left:a,fontWeight:"bold"});let o;if(s===1){o="self-"}else if(s===0){o="self-defense-"}else if(s===-1){o="enemy-"}if(h){o+="broken"}else if(i){o+="failed"}else{o+="success"}n.css("animation",`ate-char-${o} 4s linear`);n.css("--char-color",r[e]);window.setTimeout(()=>n.remove(),3800);return n}fight(h){if(this.tutorial&&typeof h==="number"){if(h===0){this.magic+=40;this.log("星空：太棒了，现在我们有足够的魔法值来使用魔法了，试一下【魔法】吧，它会给你带来增益效果！剩下的你就自己摸索吧")}else{this.log("星空：呃……你没有听我的，看来你是想自己对战了，那我就不打扰你了！我先给你个治疗法术吧！");this.game.execute("health + 240")}this.tutorial=false}else if(typeof h==="string"){let e=Math.random()<this.enemy.defenseRate;let t=e?this.enemy.defence:0;let[s,i,a]=p.computeHurtHarm(h,this.defense?0:this.game.attack-t,this.enemy.attack,this.defense,this.game.defence,this.game,this.enemy.id===13&&this.heavyAttack?.3:0,this);this.log(`你的攻击是${h}，对方的攻击是${i}`);if(e){this.log(`${this.enemy.name}选择了防御。`)}this.log(`你受到${s}点伤害`);this.game.health-=s;this.log(`你造成了${a}点伤害`);this.enemy.health-=a;if(this.withXk){let e=t<20?20-t:0;this.log(`星空造成了${e}点伤害`);this.enemy.health-=e}this.fightTimes--;if(this.fightTimes>0){return this.fightInput()}if(this.enemy.fixed&&this.heavyAttack&&a>0){this.log("你朝炮筒攻打过去，机械木马开始松动了");this.enemy.gunHealth--}if(this.battleMagic){this.game.attack-=5}}for(let e of this.roundEndCallback){e.call(this.game)}if(!this.won){this.rounds++;this.round()}}get magic(){return this._magic}set magic(e){if(e>100){e=100}this._magic=e;this.zeroTable.magic.set(e)}get chaos(){return this._chaos}set chaos(e){this._chaos=e;this.enemyTable.chaos.set(e);if(this.chaos>=100){this.log("混沌盘旋着毁灭了战场，你胜利了。");this.game.virtually(12132);this.win()}}roundEnd(e){this.roundEndCallback.push(e)}get black(){return this.game.judge(1024)&&this.enemy.id===9}}class o{constructor(e,t){this.id=e.id;this.battle=t;this.game=t.game;this.name=e.name;this.full=e.health;this.health=e.health;this.attack=e.attack;this.defence=e.defence;this.defenseRate=e.defenseRate;this.message=e.message;if(this.id===13){this.gunHealth=5;this.fixed=false}}get health(){return this._health}set health(e){this._setHealth(e);if(this.id===13){if(e<=0){this.battle.log("木马的血条似乎空了……但不要以为【自我修复】的力量就这点！");this.game.achieve(3);this._setHealth(this._health+200)}return}else if(this.id===14){if(e<=0){this.battle.win()}}if(e<=0){this.battle.win()}}_setHealth(e){this._health=e;this.battle.enemyTable.health.set(e)}get gunHealth(){return this._gunHealth}set gunHealth(e){if(e<=0){this.battle.log("机械木马剧烈地抖动！你胜利了！");this.battle.win()}this._gunHealth=e;this.battle.enemyTable.gunHealth.set(e)}}class m{constructor(){this.id=-1;this.$interface=d(".ate-interface");this.$settings=m.button().html("设置").on("click",()=>this.settingsMenu()).appendTo(this.$interface);var e=d("<div/>").addClass("ate-enter").html("Extend Air Ticket<div>Click to start</div>").prependTo(this.$interface).one("click",()=>{e.fadeOut(3e3,()=>{e.remove()})});var t=d("<div/>").addClass("ate-white").prependTo(this.$interface);var s=d("<div/>").addClass("ate-sw0rd").prependTo(this.$interface).hide().fadeIn(1e3);s.on("click",()=>{location.href="https://wiki.cvserver.top"});var i=d("#author");i.on("click",()=>{i.hide()});setTimeout(()=>{t.remove();s.fadeOut(1e3)},4e3);d(document).one("click",()=>document.getElementById("music").play());this.itemImages=[];for(let e of l.items){this.itemImages.push("./images/"+e.id+".png")}this.chooseChapter()}chooseChapter(){var s=d("<div/>").addClass("ate-chapters").appendTo(this.$interface);for(let t=1;t<=5;t++){let e=d("<div/>").addClass("ate-chapter").appendTo(s);if(l[t]){e.html("Chapter "+t).on("click",()=>{this.chapter=t;s.fadeOut(()=>{s.remove();this.run()})})}else{e.addClass("ate-chapter-locked").html("locked")}}}run(){this.$save=m.button().html("保存").on("click",()=>this.save()).appendTo(this.$interface);this.table=new h("ate-vals","状态栏").appendTo(this.$interface);this.$items=d("<div/>").addClass("ate-items").appendTo(this.$interface);this.$equipments=d("<div/>").addClass("ate-equipments").appendTo(this.$interface);this.$message=d("<div/>").addClass("ate-messages").appendTo(this.$interface);this.$battle=d("<div/>").addClass("ate-battle").appendTo(this.$interface);this.$buttons=d("<div/>").addClass("ate-choices").appendTo(this.$interface);this.$weapon=d("<div/>").html("武器").appendTo(this.$equipments);this.$armor=d("<div/>").html("防具").appendTo(this.$equipments);this.table.add("health","HP",l[this.chapter].maxHealth,"green");this.table.add("attack","Att");this.table.add("defence","Def");this.table.add("cm","CM币");this.max=10;for(let e=0;e<this.max;e++){d("<div/>").addClass("ate-item").appendTo(this.$items)}this.queue=new n(this);this.dead=false;this.attack=15;this.defence=0;var e=window.localStorage;if(e.gameData){this.store=JSON.parse(e.gameData);this.health=this.store.health;this.experience=this.store.experience;this.items=this.store.items;this.stackables=this.store.stackables;for(let e of this.items){this._add(e)}this.weapon=this.store.weapon;this.armor=this.store.armor;this.cm=this.store.cm;this.virtualExperience=this.store.virtual||[]}else{this.store={};this.health=l[this.chapter].maxHealth;this.cm=0;this.experience=[];this.stackables={};this.items=[];this.virtualExperience=[]}for(let e of l.items){if(e.stackable&&!(e.id in this.stackables)){this.stackables[e.id]=0}}this.R=Math.round(Math.random()*100)+1;this.history=[];this.exp(this.experience.length?this.experience.pop():0)}_log(e){var t=d("<span/>").html(e).css("display","none");var s=d.Deferred();this.$message.scrollTop(this.$message[0].scrollHeight);this.$message.append(t).append("<br>");t.fadeIn(this.settings.get("speed"),()=>s.resolve());this.history.push(e);return s}log(e){this.wait(()=>this._log(e))}showItems(s){var i=[];for(let t of this.items){let e=l.items[t];if(e.throwable!==false||!s){i.push(e.name)}}return i}putOn(e){var t=l.items[e];if("attack"in t&&t.attack||t.id===24){this.weapon=e}else if("defence"in t&&t.defence){this.armor=e}else{throw new Error("不可佩戴")}}get attack(){return this._attack}set attack(e){this._attack=e;if(this.weapon===24){this.table.attack.$val.html("?");return}this.table.attack.set(e)}get defence(){return this._defence}set defence(e){this._defence=e;this.table.defence.set(e)}get cm(){return this._cm}set cm(e){this._cm=e;this.table.cm.set(e)}get health(){return this._health}set health(e){if(e>l[this.chapter].maxHealth){e=l[this.chapter].maxHealth}else if(e<=0){this.die()}this._health=e;this.table.health.set(e)}get weapon(){return this._weapon}set weapon(e){if(!e){return}var t=l.items[e].name,s=this.weapon;this._weapon=e;if(s){if(s===24){window.clearInterval(this.timer.id);this.attack-=this.timer.lastAdd}else{this.attack-=l.items[s].attack}this._add(s);this.items.push(s)}this._removeItem(e);this.items.splice(this.items.indexOf(e),1);this.addImage(this.$weapon,e);if(e===24){this.timer={};this.timer.lastAdd=0;this.timer.id=window.setInterval(()=>{this.attack-=this.timer.lastAdd;this.timer.lastAdd=5+Math.floor(Math.random()*46);this.attack+=this.timer.lastAdd},5e3)}else{this.attack+=l.items[e].attack}this.$weapon.html(t)}get armor(){return this._armor}set armor(e){if(!e){return}var t=l.items[e].name,s=this._armor;this._armor=e;if(s){this.defence-=l.items[s].defence;this._add(s);this.items.push(s)}this._removeItem(e);this.items.splice(this.items.indexOf(e),1);this.addImage(this.$armor,e);this.defence+=l.items[e].defence;this.$armor.html(t)}add(i,a,h){var t=l.items[i];var a=a||1;h=h||this;const e=s=>{if(this.items.length===this.max&&!(s&&this.has(i))){var e=this.showItems(true);e.push("放弃拾取");this.waitProcess(h,t=>{t.log("已满，请丢弃一项");t.choose(e,e=>{if(e===this.max){return t.die(this)}this._remove(e);this.items.splice(e,1);this.items.push(i);if(s){this.setStackableAmount(i,this.stackables[i]+a)}this._add(i);t.die(h)})})}else{this.waitProcess(h,e=>{e.log(`已将${t.name}加入您的背包。`);this.items.push(i);if(s){this.setStackableAmount(i,this.stackables[i]+a)}this._add(i);e.waitDie(h)})}};if(t.stackable){if(this.stackables[i]===0){e(true)}else{this.setStackableAmount(i,this.stackables[i]+a)}}else{e(false)}}_add(e){var t=l.items[e];var s=this.$items.children(".ate-item"),i;s.each((e,t)=>{var s=d(t);if(s.html()==""){i=s;return false}});if(!i){throw new Error("没有找到空位")}this.addImage(i,e);i.append(t.name);var a=d("<span/>").addClass("ate-item-description").appendTo(i);var h=d("<div/>").html(t.description).appendTo(a);if(t.stackable){h.append(`<br>你有<span class="ate-item-amount">${this.stackables[e]}</span>个`)}if("attack"in t||"defence"in t||e===24){var r=m.button().html("装备").appendTo(h);r.on("click",()=>{this.putOn(e)})}var n=this.items.length-1;m.button().html("丢弃").appendTo(h).on("click",()=>{if(t.stackable){this.removeItem(e,this.queue.now())}else{this.remove(n,this.queue.now())}})}setStackableAmount(e,t){if(this.stackables[e]!==0&&t!==0){this.$items.children().eq(this.items.indexOf(e)).find(".ate-item-amount").html(""+t)}this.stackables[e]=t;if(t===0){this.items.splice(this.items.indexOf(e),1);this._removeItem(e)}}has(e){return this.items.includes(e)}remove(e,t){t=t||this;t.wait(()=>this._remove(e));return this.items.splice(e,1)[0]}_remove(e){var t=this.$items.children();t.eq(e).html("").css("backgroundImage","").appendTo(this.$items)}removeItem(e,t){if(l.items[e].stackable){return this.setStackableAmount(e,0)}return this.remove(this.items.indexOf(e),t)}_removeItem(e){this._remove(this.items.indexOf(e))}use(e,t){var s=this.remove(e,t);var i=l.items[s];t.log(i.name);for(let e of i.use){this.execute(e,t)}}exp(e){this.$message.html("");this.experience.push(e);const t=l[this.chapter].story[e];if(Array.isArray(t)){this.story(this.judgeArr(t))}else{this.story(t)}}story(h){for(let t of h.message){let e;if(typeof t==="string"){e=t}else if(Array.isArray(t)){e=this.judgeArr(t);if(!e){continue}}if(e.startsWith("/")){this.execute(e.slice(1))}else if(e.endsWith("/")){this.log(e.slice(0,-1))}else{this.log(e)}}if("battle"in h){this.battle(h.battle,this)}if("choice"in h){if("to"in h){let t=h.choice.length;let i=[];let a=[];for(let e=0;e<t;e++){let t=h.choice[e];let s=h.to[e];if(typeof t==="string"){i.push(t);a.push(s)}else if(Array.isArray(t)){let e=this.judgeArr(t);if(e){i.push(e);a.push(s)}}}this.choose(i,e=>{const t=a[e];if(typeof t==="number"){this.exp(t)}else if(Array.isArray(t)){this.exp(this.judgeArr(t))}},h.fadeChoice)}else{this.wait(()=>{let i=d("<input/>").attr("type","text").appendTo(this.$message).on("keypress",e=>{if(e.which===13){const t=i.val();if(!("#default"in h.choice)){if(t in h.choice){const s=h.choice[t];if(typeof s==="number"){this.exp(s)}else if(Array.isArray(s)){this.exp(this.judgeArr(s))}}else{return}}else{const s=h.choice[t in h.choice?t:"#default"];if(typeof s==="number"){this.exp(s)}else if(Array.isArray(s)){this.exp(this.judgeArr(s))}}i.remove()}})})}}else{const e=h.to;if(!this.settings.get("pass")){this.wait(()=>{var e=d.Deferred();this.$message.append(d("<span/>").html("点按以继续").css("font-size","50%"));this.$message.one("click",()=>e.resolve());return e})}if(typeof e==="number"){this.wait(()=>this.exp(e))}else if(Array.isArray(e)){this.wait(()=>this.exp(this.judgeArr(e)))}else{this.log("敬请期待！")}}}execute(e,t){var s=e.split(" "),i;switch(s[0]){case"get":this.add(parseInt(s[1]),s[2]&&parseInt(s[2]));break;case"remove":this.remove(this.items.indexOf(parseInt(s[1])));break;case"health":case"cm":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){this[s[0]]+=i}else if(s[1]=="-"){this[s[0]]-=i}break;case"attack":case"defence":if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(t){if(s[1]=="+"){this[s[0]]+=i;t.roundEnd(()=>{this[s[0]]-=i})}else if(s[1]=="-"){this[s[0]]-=i;t.roundEnd(()=>{this[s[0]]+=i})}}else{if(s[1]=="+"){this[s[0]]+=i}else if(s[1]=="-"){this[s[0]]-=i}}break;case"harm":t.enemy.health-=parseInt(s[1]);break;case"dodge":this.dodge(parseInt(s[1]),s[2]);break;case"bridge":this.bridge();break;case"shop":this.wait(()=>this.shop(parseInt(s[1])));break;case"achieve":this.achieve(parseInt(s[1]));break;case"edefence":case"eattack":let e=s[0].slice(1);if(s[2].startsWith("[")&&s[2].endsWith("]")){let e=s[2].slice(1,-1).split(",");i=parseInt(e[0])+Math.floor(Math.random()*(parseInt(e[1])-parseInt(e[0])+1))}else{i=parseInt(s[2])}if(s[1]=="+"){t.enemy[e]+=i;t.roundEnd(()=>{t.enemy[e]-=i})}else if(s[1]=="-"){t.enemy[e]-=i;t.roundEnd(()=>{t.enemy[e]+=i})}break;case"experience":this.virtually(parseInt(s[1]));break;case"sleep":break;default:throw new Error("Unknown Command")}}judge(e){if(typeof e==="number"){return this.experience.includes(e)}else if(typeof e==="string"){if(/^[0-9]+$/.test(e)){return this.experience.includes(parseInt(e))}let s;if(s=/^([\w\!\&\|]+?)\|([\w\!\&\|]+)$/.exec(e)){return this.judge(s[1])||this.judge(s[2])}if(s=/^([\w\!\&\|]+?)&([\w\!\&\|]+)$/.exec(e)){return this.judge(s[1])&&this.judge(s[2])}if(e.startsWith("!")){return!this.judge(e.slice(1))}if(s=/^([a-z]+)(\d+)$/.exec(e)){let e=s[1];let t=parseInt(s[2]);switch(e){case"r":return this.R===t;case"h":return this.health===t;case"i":return this.has(t);case"a":return this.armor===t;case"w":return this.weapon===t;case"c":return this.cm>=t;case"v":return this.virtualExperience.includes(t);default:throw new Error(`Illegal condition prefix '${e}'.`)}}}}static isValidCondition(e){return typeof e==="number"||/^[richawv0-9&\|!]+$/.test(e)}judgeArr(t){var s=t.length;if(!m.isValidCondition(t[1])){return t[a(0,s-1)]}var i;for(let e=0;e<s;e++){if(e===s-1){i=t[e];break}if(this.judge(t[e+1])){i=t[e];break}e++}return i}_choose(s,i,a){d(".ate-choices > *").hide();var h=d("<div/>").appendTo(this.$buttons);for(let t in s){let e=d("<div/>").addClass("ate-choice").html(s[t]).appendTo(h);e.on("click",()=>{setTimeout(()=>h.remove());d(".ate-choices > *").show();i.call(s,parseInt(t))});if(a&&a.includes(parseInt(t))){e.css("opacity","0.05")}}h.append(m.clear())}choose(e,t,s){this.wait(()=>this._choose(e,t,s))}wait(t){if(typeof t==="function"){this.queue.push(t,this)}else{this.queue.push(()=>{var e=d.Deferred();setTimeout(()=>e.resolve(),t);return e},this)}}save(){if(this.queue.owner!==0){return void this.notify("战斗无法保存")}var e=d.merge([],this.items);if(this.weapon){e.push(this.weapon)}if(this.armor){e.push(this.armor)}var t={health:this.health,items:e,experience:this.experience,weapon:this.weapon,armor:this.armor,cm:this.cm,stackables:this.stackables,virtual:this.virtualExperience};localStorage.gameData=JSON.stringify(t);this.notify("保存成功")}battle(t,s){s.wait(()=>{var e=new p(l.battle[t],this,s);e.run()})}dodge(n,o){this.waitProcess(this,a=>{this.$interface.addClass("battling");const t=()=>{let e=r.val();if(typeof e!=="string"){throw new Error("Str should be string")}if(!p.check5Capitals(e)){return}h.remove();let[t,s,i]=p.computeHurtHarm(e,0,n,true,0,this);a.log(`你的攻击是${e}，${o}的攻击是${s}。`);a.log(`你被扣血${t}`);this.health-=t;a.wait(()=>void this.$interface.removeClass("battling"));a.wait(()=>a.die(this))};let h=d("<div/>").appendTo(this.$battle);let r=d("<input/>").attr("type","text").appendTo(h).on("keypress",e=>{if(e.which===13)t()});if(this.settings.get("random")){let t=[];for(let e=0;e<5;e++){t.push(65+Math.floor(Math.random()*4))}r.val(String.fromCharCode(...t))}let e=m.button().html("攻击！").appendTo(h).on("click",()=>t())})}bridge(){this.log("选择一座桥以通过");const a=()=>this.Process(i=>i.choose(["A","B","C"],e=>{var t=Math.floor(Math.random()*3);var s=["A","B","C"];if(e===t){s.splice(t,1);i.log(`翻转地板组成了桥${s.join()}，你没通过桥！`);i.die(a())}else{i.log("你通过了桥！");i.die(this)}})).go();this.wait(()=>a())}shop(e){var n=l.shop[e];const o=()=>this.Process(s=>{var i={},a=[],h=[];for(let t in n){let e=n[t];if(Array.isArray(e)){e=this.judgeArr(e);if(!e){continue}}i[t]=e;h.push(t);a.push(l.items[t].name+` [cost CM币${e}个]`)}var r=a.length;a.push("离开");s.choose(a,e=>{if(e===r){return s.die(this)}if(this.items.length===this.max){s.log("背包空间不够，你离开了商店");return s.die()}var t=parseInt(h[e]);if(i[t]>this.cm){s.log("你的CM币不够！")}else{this.cm-=i[t];this.add(t,1,s)}s.wait(()=>s.die(o()))})}).go();this.wait(()=>o())}virtually(e){this.virtualExperience.push(e)}die(){this.log("黑暗再次降临。");if(this.has(2)){this.log("使用复活爱心吗?");this.choose(["是","否"],e=>{if(!e){this.setStackableAmount(2,this.stackables[2]-1);this.health=100;this.log("那么，你将再次驱散黑暗")}else{this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData}})}else{this.log("但是，希望似乎保佑不了你");this.log("看来，黑暗将会再度笼罩你");this.log("You died.");delete localStorage.gameData;delete this.queue}}get settings(){var s;var e={speed:1500,pass:false};function i(){s=localStorage.ateSettings?JSON.parse(localStorage.ateSettings):e}function a(e,t){s[e]=t;localStorage.ateSettings=JSON.stringify(s);i()}i();return{get(e){return s[e]},set(e,t){a(e,t)},toggle(e){a(e,!s[e])}}}settingsMenu(){if(d(".ate-settings").length>0){return}var s=d("<div/>").addClass("ate-settings").appendTo(this.$interface);var i=d("<div/>").addClass("ate-cover").appendTo(this.$interface);var e=d("<ul/>").appendTo(s);var a=d("<input>").attr("type","text").val(this.settings.get("speed")).appendTo(d("<li/>").html("消息播放时间/ms").appendTo(e));var t=this.settings.get("pass");var h=m.button(t&&"on").html(t?"是":"否").appendTo(d("<li/>").html("无选项自动跳剧情").appendTo(e));h.on("click",()=>{h.html(this.settings.get("pass")?"否":"是");this.settings.toggle("pass");h.toggleClass("ate-button-on")});var r=this.settings.get("random");var n=m.button(r&&"on").html(r?"是":"否").appendTo(d("<li/>").html("战斗攻击自动填入").appendTo(e));n.on("click",()=>{n.html(this.settings.get("random")?"否":"是");this.settings.toggle("random");n.toggleClass("ate-button-on")});if(this.history){m.button("negative").html("清档").appendTo(s).on("click",()=>{delete localStorage.gameData;this.notify("存档已清除！")});s.append("<div>历史记录：</div>");var o=d("<ol/>").addClass("ate-history").appendTo(s);for(let e of this.history){d("<li/>").html(e).appendTo(o)}}var l=btoa(localStorage.gameData||"");var c=d("<textarea/>").val(l).appendTo(s);d("<div/>").addClass("ate-settings-done").appendTo(s).on("click",()=>{const e=a.val();if(typeof e!=="string"){throw new Error("$speed.val() is a str")}if(e.match(/^\d+$/)){this.settings.set("speed",parseInt(e))}const t=c.val();if(typeof t!=="string"){throw new Error("$speed.val() is a str")}if(t!==l){localStorage.gameData=atob(t)}s.animate({left:"-100%"},3e3,()=>s.remove());i.remove()})}static clear(){return d("<div/>").css("clear","both")}addImage(e,t){if(t<this.itemImages.length){e.css("backgroundImage",`url(${this.itemImages[t]})`)}}achieve(e){if(this.achievements.includes(e))return;var t=l.achievement[e];var s=d("<div/>").addClass("ate-achievement");this.$interface.append(s);d("<div/>").addClass("ate-achievement-title").html("成就："+t.name).appendTo(s);d("<span/>").addClass("ate-achievement-content").html(t.description).appendTo(s);s.animate({opacity:1,left:0},2e3);setTimeout(()=>s.fadeOut(3e3),12e3);this.achievements.push(e)}get achievements(){var t=localStorage.ateAchievements?JSON.parse(localStorage.ateAchievements):[];return{push(e){t.push(e);localStorage.ateAchievements=JSON.stringify(t)},includes(e){return t.includes(e)},get length(){return t.length}}}static button(e){var t=d("<div/>").addClass("ate-button");return t.addClass("ate-button-"+e)}notify(e){var t=d("<div/>").addClass("ate-notification").appendTo(this.$interface).html(e);t.fadeIn(1500);t.fadeOut(3e3,()=>t.remove())}Process(e){return new t(e,this)}waitProcess(e,t){e.wait(()=>this.Process(t).go())}waitChoose(s,e,i){this.waitProcess(s,t=>{t.choose(e,e=>{i(e,s,i);t.die(s)})})}}var s=new m;document.title="游玩 Extend Air Ticket";d("#firstHeading").html(`--- Extend Air Ticket v ${e} ---`);d("#version").html(e)})(jQuery,ateData,"2.12.0");